<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stephen Ro">
<meta name="dcterms.date" content="2023-07-06">
<meta name="description" content="Is $20 a good price for this bottle? Natural Language Processing has the answer!">

<title>Stephen Ro - Price-Sentiment Analysis Model using BERT</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Stephen Ro</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume/stephen_ro_resume.pdf" rel="" target="">
 <span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/royourboat" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/stephenro/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:stephensro@gmail.com" rel="" target=""><i class="bi bi-envelope" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Price-Sentiment Analysis Model using BERT</h1>
                  <div>
        <div class="description">
          Is $20 a good price for this bottle? Natural Language Processing has the answer!
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Python</div>
                <div class="quarto-category">JSON</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://royourboat.github.io/">Stephen Ro</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 6, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-price-sentiment-data" id="toc-what-is-price-sentiment-data" class="nav-link active" data-scroll-target="#what-is-price-sentiment-data">What is price-sentiment data?</a></li>
  <li><a href="#part-1-scraping-wines-and-reviews" id="toc-part-1-scraping-wines-and-reviews" class="nav-link" data-scroll-target="#part-1-scraping-wines-and-reviews">Part 1: Scraping Wines and Reviews</a></li>
  <li><a href="#part-2-selecting-reviews-with-prices" id="toc-part-2-selecting-reviews-with-prices" class="nav-link" data-scroll-target="#part-2-selecting-reviews-with-prices">Part 2: Selecting Reviews with Prices</a></li>
  <li><a href="#part-3-training-data" id="toc-part-3-training-data" class="nav-link" data-scroll-target="#part-3-training-data">Part 3: Training Data</a>
  <ul class="collapse">
  <li><a href="#partisan-sentiment-neutral-is-negative" id="toc-partisan-sentiment-neutral-is-negative" class="nav-link" data-scroll-target="#partisan-sentiment-neutral-is-negative">Partisan Sentiment! Neutral is negative</a></li>
  </ul></li>
  <li><a href="#part-4-define-a-metric" id="toc-part-4-define-a-metric" class="nav-link" data-scroll-target="#part-4-define-a-metric">Part 4: Define A Metric</a></li>
  <li><a href="#part-5-pre-processing-strategy" id="toc-part-5-pre-processing-strategy" class="nav-link" data-scroll-target="#part-5-pre-processing-strategy">Part 5: Pre-Processing Strategy</a>
  <ul class="collapse">
  <li><a href="#nlp-strategies" id="toc-nlp-strategies" class="nav-link" data-scroll-target="#nlp-strategies">NLP Strategies</a></li>
  <li><a href="#sentence-embedding-with-s-bert" id="toc-sentence-embedding-with-s-bert" class="nav-link" data-scroll-target="#sentence-embedding-with-s-bert">Sentence Embedding with S-BERT</a></li>
  </ul></li>
  <li><a href="#part-6-preparing-data" id="toc-part-6-preparing-data" class="nav-link" data-scroll-target="#part-6-preparing-data">Part 6: Preparing Data</a>
  <ul class="collapse">
  <li><a href="#training-data" id="toc-training-data" class="nav-link" data-scroll-target="#training-data">Training Data</a></li>
  </ul></li>
  <li><a href="#model-fits" id="toc-model-fits" class="nav-link" data-scroll-target="#model-fits">Model Fits</a>
  <ul class="collapse">
  <li><a href="#a.-dummy-classifier" id="toc-a.-dummy-classifier" class="nav-link" data-scroll-target="#a.-dummy-classifier">A. Dummy Classifier</a></li>
  <li><a href="#b.-logistic-regression" id="toc-b.-logistic-regression" class="nav-link" data-scroll-target="#b.-logistic-regression">B. Logistic Regression</a></li>
  <li><a href="#c.-complement-naive-bayes" id="toc-c.-complement-naive-bayes" class="nav-link" data-scroll-target="#c.-complement-naive-bayes">C. Complement Naive Bayes</a></li>
  <li><a href="#d.-support-vector-machine" id="toc-d.-support-vector-machine" class="nav-link" data-scroll-target="#d.-support-vector-machine">D. Support Vector Machine</a></li>
  <li><a href="#e.-random-forest" id="toc-e.-random-forest" class="nav-link" data-scroll-target="#e.-random-forest">E. Random Forest</a></li>
  <li><a href="#pipelines" id="toc-pipelines" class="nav-link" data-scroll-target="#pipelines">Pipelines</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/19edf47d-1-BeFunky-collage-21.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Image by LCBO</figcaption>
</figure>
</div>
<p>This is a picture of an LCBO store in Toronto, Canada. All of the wines are exciting to look at and I want to try some! But, how will I know what’s good? There’s thousands to choose from! Looking on their app, I found two things:</p>
<ul>
<li>The interesting bottles had very few reviews</li>
<li>I confirmed that I do not know much about wine, so reviews aren’t all that helpful</li>
</ul>
<p>I gave up and asked an LCBO wine guide for recommendations. Both of the bottles recommended were horrendous. The bite to my wallet hurt too.</p>
<p>An incredibly popular wine app, Vivino, is great at identifying wines using their image recognition software. But, I’m not going to stand around all day taking pictures of wine. It is good at filtering out which bottles have under 4-stars. But, I would also like a good deal after my expensive experience.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/778ad5c7-1-1200x800.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Image recognition feature on the Vivino app. Image by David Silverman/Getty Images</figcaption>
</figure>
</div>
<p><span style="font-size:20pt" data-aligh="center">“You have to spend a little to discover.”</span></p>
<p>My goal is to increase the odds of finding well-priced discoveries. Using Natural Language Processing and machine learning techniques, I identify wines at the LCBO with high price-sentiments based on Vivino reviews. Here’s how I did it.</p>
<section id="what-is-price-sentiment-data" class="level1">
<h1>What is price-sentiment data?</h1>
<p>I noticed about 0.5% (~1 in 200) of reviews on Vivino contain (1) the price a user paid, and (2) the sentiment for that price. Samples of reviews with “price-sentiment” are shown in the diagram below.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/51001aa5-1-price_sentiment_diagram.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">price_sentiment_diagram.png</figcaption>
</figure>
</div>
<p>I realized that with enough price-sentiment reviews, I could estimate whether a bottle’s price was “good” based on what everyone else has paid. For example, the bottle above sells for $13.99 and found users who:</p>
<ul>
<li>paid <span style="font-weight:bold">more</span> than $13.99 and <span style="color:green;">liked</span> the price, and</li>
<li>paid <span style="font-weight:bold">less</span> than $13.99 and <span style="color:red;">disliked</span> the price</li>
</ul>
<p>There are several dozens of bottles at the LCBO with 10k to 100k+ reviews on vivino. That translates into roughly 50 to 500 price-sentiment reviews. That is quite a lot of data per bottle and sufficient to inform a recommendation algorithm. So, let’s make one!</p>
</section>
<section id="part-1-scraping-wines-and-reviews" class="level1">
<h1>Part 1: Scraping Wines and Reviews</h1>
<p>I created a bot on GitHub Actions to scrape all of LCBO’s 9k+ wine data. The data is uploaded to my postgreSQL database. For more details, check out these blogs:</p>
<p>I matched the LCBO wines to wines on Vivino using their explore API. The API returns several candidate results ranked by similarity. However, sometimes the first result is not correct due to their being numerous wines and vintages with similar names. For example, Mike Weir Chardonnay, Mike Weir Limited Edition Barrel Fermented Chardonnay, Limited Edition 4 Barrel Chardonnay. A simple verification for the matches is to minimize the intersection of words contained in two wine names.</p>
<p>After that, I obtained 6M reviews from Vivino for wines available at the LCBO using Vivino’s API. I look into the reviews <a href="../2023-07-06-vivino-part1/">here</a>.</p>
</section>
<section id="part-2-selecting-reviews-with-prices" class="level1">
<h1>Part 2: Selecting Reviews with Prices</h1>
<p>Reviews containing a price are identified by looking for dollar signs immediately adjacent to an integer or flow. For example, “$50”, “39.99$”.</p>
<div class="cell" data-execution_count="1">
<details>
<summary>Code: Use regex for price (integer) amount</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> getPrice(text):</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> text: <span class="co"># Reject empty strings</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return text if dollar sign is head: E.g., "Paid $10 bucks" --&gt; "$10"</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    textLeadDollarSign <span class="op">=</span> re.search(<span class="vs">r'\w*\$\d+(?:\.\d+)?\w*'</span>, text) </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> textLeadDollarSign:</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        textPrice <span class="op">=</span> textLeadDollarSign</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return text if dollar sign is tail: E.g., "Paid 10$ bucks" --&gt; "10$"</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        textTailDollarSign <span class="op">=</span> re.search(<span class="vs">r'\w*\d+(?:\.\d+)?\$\w*'</span>, text) </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        textPrice <span class="op">=</span> textTailDollarSign</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reject no results</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> textPrice:</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get float representing price.</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    textPrice <span class="op">=</span> textPrice.group(<span class="dv">0</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    textPrice <span class="op">=</span> re.search(<span class="vs">r'\d+(?:\.\d+)?'</span>, textPrice).group(<span class="dv">0</span>) </span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    textPrice <span class="op">=</span> textPrice.replace(<span class="st">'$'</span>,<span class="st">''</span>)    <span class="co"># Delete '$' sign</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    price <span class="op">=</span> <span class="bu">int</span>(math.ceil(<span class="bu">float</span>(textPrice)))  <span class="co"># Round up to nearest dollar</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> price</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This rule-based filter found approximately 55k reviews contain prices.</p>
<div class="cell" data-execution_count="2">
<div class="cell-output cell-output-display" data-execution_count="2">
<table class="table table-sm table-striped small">
<caption>Samples of reviews with prices </caption>
<colgroup>
<col style="width: 5%">
<col style="width: 95%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">Rating</th>
<th style="text-align: left;">Review</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: left;">Just a simple quaffer. Not much going on here at all. Have with salads or Thai food. Good with take-out sushi. Decent value at $11 but not textbook Viognier.</td>
</tr>
<tr class="even">
<td style="text-align: right;">3.5</td>
<td style="text-align: left;">It’s very popular, but not my cup of vino given the “juicy” style; as opposed to tannic big cabs that I prefer. All in all would definitely drink again but only buy it for myself at a sub $50 pp</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3.5</td>
<td style="text-align: left;">Very nice. Much more expensive in a restaurant. If you can find it for $15… buy some.</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">Tasted w/Nat at Russ’s Wine &amp; Food Experience 2018 (Reserve Room selection) at Embassy Suites 2/23/18. 100% Cabernet Sauvignon. Well structured with complex aromas of plum jam, green pepper, raising, tobacco and touch of oak. Balanced in the mouth with soft and ripe tannins. $19.99</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: left;">I picked this up at a Kroger after an impromptu wine tasting there. Under $10! This is an excellent value for the price! I’m NOT generally an American Chardonnay kid either (I’m not even sure what possessed me to try it!), but this is nice! Golden straw in the glass. Warm lemon curd and fresh lime zest on the nose. Pineapple, clementine and honeydew on the palate. Balanced, fresh and lovely. It’s an absolute win.</td>
</tr>
<tr class="even">
<td style="text-align: right;"></td>
<td style="text-align: left;">Wine Enthusiast: 90pts</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="part-3-training-data" class="level1 page-columns page-full">
<h1>Part 3: Training Data</h1>
<p>A common strategy for curating training data in sentiment analysis is to select 1-star and 5-star reviews and assume they represent negative and positive sentiments. An alternative is to label reviews manually. While manual labelling requires substantial time to complete, there are several benefits that cannot be overlooked:</p>
<ol type="1">
<li>Reviews can highlight limitations of your classification rules. Perhaps labelling reveals 5% of reviews cannot be definitively classified as positive or negative. So, a third class is necessary since 5% missclassification may be an unacceptable loss-margin for your use case. Alternatively, 5% may be an acceptable loss-margin that supports your strategy to dismiss the class entirely.</li>
<li>A set of undiscovered problematic reviews are found and filtered out with an additional pre-processing layer. This could save headaches when interpreting confusing results. E.g., How does your model perform with emojis?</li>
<li>Identifying words with dual sentiments are beneficial tests if you are incorporatinga Large Language Model (LLM). For instance, the reviews “This price is a steal” and “They’re stealing your money” are often labelled negative by LLMs due to the body of text it was trained on.</li>
<li>Building domain knowledge gives insight into what is valuable and talked about in a community. This can help provide direction for your project.</li>
<li>Learning the wine nomenclature can improve the quality and depth of your presentations!</li>
</ol>
<p><strong>My primary reason</strong> to manually label data is to learn new techniques. I also treat the labelled dataset as “tracer particles” to observe how other sentiment analyses perform. For instance, I can measure what fraction of manually labeled sentiments are misclassified by the 1-5-star strategy introduced earlier.</p>
<p>So. I ended up with 5,500 manually labelled price-sentiment reviews! This sounds like a lot, and fortunately it is! But, keep in mind that (1) it was fun to label them, (2) I had help, (3) there is a 520-character limit, and (4) most reviews look like “good deal for $6” which is very fast to label.</p>
<p>Let’s see the data!</p>
<section id="samples-of-labelled-price-sentiments" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="samples-of-labelled-price-sentiments">Samples of labelled price-sentiments</h4>
<div class="cell" data-execution_count="4">
<div class="cell-output cell-output-display" data-execution_count="4">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 10%">
<col style="width: 15%">
<col style="width: 75%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">Rating</th>
<th style="text-align: left;">Sentiment</th>
<th style="text-align: left;">Review</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: left;">Positive</td>
<td style="text-align: left;">Fruity, dry, good value at $10.99</td>
</tr>
<tr class="even">
<td style="text-align: right;">4.5</td>
<td style="text-align: left;">Positive</td>
<td style="text-align: left;">Spot on for what it is. Woody, leather, dried fruits, vanilla, and more. Great buy under $15</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3.5</td>
<td style="text-align: left;">Neutral</td>
<td style="text-align: left;">Hey it’s a $10 bottle. Not that bad for the money.</td>
</tr>
<tr class="even">
<td style="text-align: right;">3.5</td>
<td style="text-align: left;">Neutral</td>
<td style="text-align: left;">Disappointing Barolo but worth the just under $30 price tag. Satisfactory wine nothing to write home about.</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.5</td>
<td style="text-align: left;">Negative</td>
<td style="text-align: left;">I didn’t like this cab enough to justify the $20 price- there’s several less expensive reds I like better.</td>
</tr>
<tr class="even">
<td style="text-align: right;">3.7</td>
<td style="text-align: left;">Negative</td>
<td style="text-align: left;">Not worth the 50$</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4.5</td>
<td style="text-align: left;">Don’t know</td>
<td style="text-align: left;">Clear classic</td>
</tr>
<tr class="even">
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">On it’s Way Down</td>
</tr>
<tr class="odd">
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Paid 70$ in 2000</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Don’t know</td>
<td style="text-align: left;">10/22/202</td>
</tr>
<tr class="odd">
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Bought at Costco $7.99. Really liked, not overly sweet and has a nice selection rich taste with substance.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell page-columns page-full" data-execution_count="5">

<div class="no-row-height column-margin column-container"><div class="cell-output cell-output-display" data-execution_count="5">
<table class="table table-sm table-striped small">
<caption>Frequency of Price-Sentiment </caption>
<thead>
<tr class="header">
<th style="text-align: left;">Sentiment</th>
<th style="text-align: right;">Proportion</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Positive</td>
<td style="text-align: right;">0.62</td>
</tr>
<tr class="even">
<td style="text-align: left;">Neutral</td>
<td style="text-align: right;">0.11</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Negative</td>
<td style="text-align: right;">0.15</td>
</tr>
<tr class="even">
<td style="text-align: left;">Don’t know</td>
<td style="text-align: right;">0.13</td>
</tr>
</tbody>
</table>
</div></div></div>
<p>I use four labels to categorize my reviews with the following guidelines/rules:</p>
<ol type="1">
<li>Positive: Explicitly positive sentiment on price.</li>
<li>Neutral: Mixed or lack of sentiment on price.</li>
<li>Negative: Explicitly negative sentiment on price.</li>
<li>Don’t know: Missing sentiment on price.</li>
</ol>
<p>The distribution of price-sentiments is <strong>shown on the right margin</strong>. Nearly 2/3 of price-sentiments are positive. The remaining sentiments are of similar magnitude ~13%.</p>
<p>Note: a neutral sentiment is not positive or negative (see <a href="https://blog.datumbox.com/the-importance-of-neutral-class-in-sentiment-analysis/">Vryniotis</a> for a nice discussion). For example, “not bad” is not automatically “good”.</p>
<div class="cell" data-execution_count="6">
<div class="cell-output cell-output-display">
<div id="fig-sentiment-histogram" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-sentiment-histogram-output-1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Price-sentiment histograms across star-rating</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="cell-output cell-output-display">
<div id="fig-sentiment-violinplot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-sentiment-violinplot-output-1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Price-sentiment violin plots across star-rating</figcaption>
</figure>
</div>
</div>
</div>
<p>Its no surprise that price-sentiments and star ratings are correlated. It is surprising to see the neutral sentiments resting distinctly between 2- and 4-stars with small tails. This supports the neutral category being a real third category in sentiment analysis, and it is nearly equal in proportion to the negative sentiments.</p>
<p>Selecting 1- and 5-star reviews as proxies for negative and positive sentiment appears reasonable after considering the relative contributions from each sentiment per rating. The ratio of positive-to-negative sentiments above 4.5 stars is 26-to-1. The ratio of negative-to-positive sentiments below 1.5 stars is 14-to-1. This suggests approximating the price-sentiment with the star rating may be viable.</p>
<p>The figure below shows “Don’t know” sentiments lean towards higher star-ratings. This suggests there may be more “Don’t knows” will be falsely predicted as positive than negative. This is a better than the opposite considering how the neutral and negative sentiments are a minority class.</p>
<div class="cell" data-execution_count="8">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="partisan-sentiment-neutral-is-negative" class="level2">
<h2 class="anchored" data-anchor-id="partisan-sentiment-neutral-is-negative">Partisan Sentiment! Neutral is negative</h2>
<p>After running a couple experiments, it became immediately clear that most neutral sentiments are falsely classified as positive or negative. This is because distinguishing “not bad” from “good” requires a lot more samples to capture context and language <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. I decided to combine the neutral and negative categories as negative because:</p>
<ul>
<li>I am less likely to purchase a bottle considered “not bad”, let alone a bottle that is “not good”. This is my bias.</li>
<li>The neutral and negative categories generally overlap with respect to star-ratings.</li>
<li>The pool of negative sentiment data is doubled.</li>
<li>Eliminating a category eliminates a set of potential false classifications.</li>
</ul>
</section>
</section>
<section id="part-4-define-a-metric" class="level1">
<h1>Part 4: Define A Metric</h1>
<p>The “best” model requires (A) definitions of success, (B) models to compare to, and (C) costs or economics of running these models (i.e., do I need a supercomputer?). Models also have a shelf-life because the environment is not static (e.g., culture, technologies, ideas). Your model may create feedback and change the dynamic of the environment too. For instance, if you modelled the stock market and made a ton of money, you’re influence affects stocks and will eventually weaken your original model.</p>
<p>Let’s define the nature of our product and understand what would be a successful outcome from a model.</p>
<section id="product-goals" class="level4">
<h4 class="anchored" data-anchor-id="product-goals">Product goals:</h4>
<p>The current deliverable is a recommendation scale. As stated in the introduction, the number of positive and negative sentiments (conditional on price) generates the following sentiment-ratio to the user:</p>
<ol type="1">
<li><strong>56 out of 61 recommend this price!</strong></li>
<li><strong>7 out of 10 recommend this price!</strong></li>
</ol>
<p>Misclassifying a “7 out of 10” (truth) as a “6 out of 10” (model) by 10% may be sufficient to dissuade a customer. Likewise, a customer may decide to buy a bottle with a falsely higher sentiment-ratio. Therefore, the positive and negative categories are both important to get right. <strong>We value both precision and recall for both categories.</strong></p>
<p>The “Don’t knows” (DKs) are often neglected in these types of analyses. DKs effectively act as noise burying our desired signal. Noise can act unfairly and bias results to ultimately degrade a product’s quality. Fortunately, the work creating our training set reveals DKs to be the smallest proportion of reviews with 13%. Negatives (merged with neutrals) are 26% and the remaining are positive sentiments. <strong>A reduction in true DKs (i.e., high recall) is a plus</strong> since we want to minimize noise from our reviews.</p>
<p>I do not care about the precision of DKs since those are discarded. Mislabelling positive or negative sentiments is serious since we do not want to throw out reviews and reduce our pool of recommended bottles. But, this emphasizes the value of positive and negative recall and not the precision of DKs.</p>
<p>The F-score is a harmonic mean of recall and precision with an added real positive coefficient <span class="math inline">\(\beta\)</span> that acts as a weight. Equal importance is applied to recall and precision when <span class="math inline">\(\beta=1\)</span>.</p>
<ul>
<li>We want to use an F1-score for both the positive and negative sentiments since precision and recall are valuable in the recommender.</li>
<li>Only recall is important for the DKs since we want to minimize noise. (i.e., <span class="math inline">\(\beta\rightarrow\infty\)</span>).</li>
</ul>
<p>I choose the following weighted score to compare between models: <span class="math display">\[
\mathrm{Weighted\ Score} = \frac{F_1(\mathrm{Positive}) + F_1(\mathrm{Negative}) + C_{\mathrm{DK}}R(\mathrm{Don't\ know})}{2 + C_{\mathrm{DK}}}
\]</span> where <span class="math inline">\(F_1\)</span> is the F1-score and <span class="math inline">\(R(\mathrm{Don't\  know})\)</span> is the recall of DKs. The positive and negative categories are weighted equally (rather than by frequency) due to their equal importance in the recommender. DK’s weight, <span class="math inline">\(C_{\mathrm{DK}}\)</span>, is the ratio of DK and negative frequencies (i.e., approximately 0.13 / 0.26 = 0.5). This choice captures the worst case scenario where all DKs are classified as negative which is the next smallest category.</p>
<p>The custom scorer is defined below which I’ll use in a grid search. With our metric, we can start setting up our model experiments!</p>
<div class="cell" data-execution_count="10">
<details>
<summary>Code: Weighted scorer</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> make_scorer, recall_score, f1_score</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>weightsVector <span class="op">=</span> np.array([<span class="dv">1</span>, <span class="dv">1</span>, freqDict[<span class="st">"Don't know"</span>]<span class="op">/</span>(freqDict[<span class="st">'Neutral'</span>] <span class="op">+</span> freqDict[<span class="st">'Negative'</span>])])</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>categoryLabels <span class="op">=</span> [<span class="st">'Positive'</span>, <span class="st">'Negative'</span>, <span class="st">"Don't know"</span>]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> weightedScore(y_true, y_pred):</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    f1 <span class="op">=</span> f1_score(y_true, y_pred, labels <span class="op">=</span> categoryLabels, average<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    recall <span class="op">=</span> recall_score(y_true, y_pred, labels <span class="op">=</span> categoryLabels, average<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    f1Dict <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(categoryLabels, f1))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    recallDict <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(categoryLabels, recall))</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    scoreVector <span class="op">=</span> np.array([f1Dict[<span class="st">'Positive'</span>], f1Dict[<span class="st">'Negative'</span>], recallDict[<span class="st">"Don't know"</span>]])</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    score <span class="op">=</span> np.dot(scoreVector, weightsVector) <span class="op">/</span> np.<span class="bu">sum</span>(weightsVector)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> score</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>sentimentScorer <span class="op">=</span> make_scorer(weightedScore, greater_is_better <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="part-5-pre-processing-strategy" class="level1">
<h1>Part 5: Pre-Processing Strategy</h1>
<section id="nlp-strategies" class="level2">
<h2 class="anchored" data-anchor-id="nlp-strategies">NLP Strategies</h2>
<section id="bag-of-words---can-skip-to-sentence-transformers" class="level4">
<h4 class="anchored" data-anchor-id="bag-of-words---can-skip-to-sentence-transformers">Bag of words - Can skip to Sentence Transformers</h4>
<p>A popular sentiment analysis strategy is the bag-of-words model. The general procedure is relatively simple.</p>
<p>In short, a document is disassociated into a list of words and the context for those words are destroyed. Words are lemmatized and filtered with a list of ‘stop words’. A TF-IDF vectorizer (or whatever your favourite measuring stick for a word’s importance) counts the frequency of a word in a given document (TF) and across documents (IDF) to construct a metric for a word’s “importance”. A machine learning model then delineates words that correspond to a document’s label.</p>
<p><strong>This strategy will work poorly</strong> for price-sentiment analysis. The majority of text in reviews labelled “Don’t know” is identical to the positive and negative reviews because the price-sentiment is typically stated in a few words. In other words, trying to find a missing signal that is typically weak in a sea of noise is challenging for a bag of words model. Minimizing false positives relies strongly on the quality of stop words and lemmatization. This is a lot of work! Trust me, I tried it.</p>
<p>So, what do we do? (See next section)</p>
<p><em>Side notes for if you try bag of words:</em></p>
<p>A popular NLP module called spaCy has several convenient features including lemmatization. Be careful!!! Here is a shocking lemmatized sample from spaCy’s trained pipeline ‘en_core_web_sm-wine’:</p>
<ol type="1">
<li>“Had better $20 wine” (original)</li>
<li>“Had well $20 wine” (with lemmatization)</li>
<li>“well $20” (with stop word deletion)</li>
</ol>
<p>After correcting this lemmatization, my model robustly improved by a couple percent! While the bag-of-words model is fast to compute, it requires careful attention and good familiarity with wine reviews to ensure algorithms are working as we intend.</p>
<p>A useful trick I found was to run a separate TF-IDF on reviews to identify irrelevant wine nomenclature. For example, most wine reviews list various flavour notes and measures of acidity, tannins, boldness, etc. These act as noise in our bag of words and can be added to your list of stop words.</p>
</section>
<section id="sentence-transformers.-are.-amazing." class="level4">
<h4 class="anchored" data-anchor-id="sentence-transformers.-are.-amazing.">Sentence Transformers. Are. Amazing.</h4>
<p>Identifying whether a review contains price-sentiment requires context. For instance, here are two real reviews with and without price-sentiment:</p>
<ul>
<li>“Awesome wine for price, selling at coop for $7/bottle”</li>
<li>“Great smell and taste $62 at Binnys with 5% off, might have been on sale”</li>
</ul>
<p>Here are the versions without stopwords:</p>
<ul>
<li>awesome, price, selling, coop, $7/bottle</li>
<li>great, $62, binnys, 5%, off, sale</li>
</ul>
<p>Context is vital to separating the DK labels! That’s where Sentence Transformers (STs) shine. STs are trained on an enormous corpus of text to learn the intent and meaning behind sentences. Very minimal pre-processing is required before transforming a sentence. There are setbacks that may prevent you from using STs, however. Here is a list of ST nuances and their relevance for wine reviews:</p>
<ul>
<li><p><strong>Input length</strong>: STs commonly have 512 token limits which roughly corresponds to 300-400 English words. Longer documents will be truncated unless they are broken into pages, paragraphs, or sometimes sentences. Wine reviews have a 520-character limit or approximately 100 words (see this <a href="../2023-07-06-vivino-part1/#fig-words">figure</a>), so this is not an issue.</p></li>
<li><p><strong>Training data</strong>: The ST model is trained on an <a href="https://huggingface.co/sentence-transformers/all-roberta-large-v1">enormous corpus</a> of text data. It will perform better if your text data is similar to ST’s training data. The good news is that you can fine-tune an ST model to learn your your text’s domain knowledge (e.g., astrophysics)! More on this to come.</p></li>
<li><p><strong>GPU</strong>: A GPU can decrease the computational time to transform a sentence by one to two orders of magnitude compared to a CPU. If you have a large set of data, this can be an expensive step without a GPU!</p></li>
<li><p><strong>Context</strong> Unlike bag of words, STs are designed to capture the context surrounding words as well. STs attempt to capture the intention or meaning in a sentence. Thus, the output vectors are “sentence” embeddings rather than an array of “word” embeddings generated from a vectorizer. Steps 1-5 from the bag of words procedure are <strong>collapsed into one step</strong>! Some pre-processing with punctuation might be, however (e.g., a wall of emojis is probably difficult to interpret).</p></li>
</ul>
<p>Let’s give sentence embeddings a try.</p>
</section>
</section>
<section id="sentence-embedding-with-s-bert" class="level2">
<h2 class="anchored" data-anchor-id="sentence-embedding-with-s-bert">Sentence Embedding with <a href="https://www.sbert.net/">S-BERT</a></h2>
<section id="import-sentence-transformer" class="level4">
<h4 class="anchored" data-anchor-id="import-sentence-transformer">Import sentence-transformer</h4>
<p>After installing <a href="https://www.sbert.net/">sentence-transformers</a>, <a href="https://www.sbert.net/docs/pretrained_models.html">select an embedding model</a> and download it automatically using the code below. Here, I show what typical values the embedding vectors take on.</p>
<div class="cell" data-execution_count="11">
<details open="">
<summary>Code: sentence-transformer</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sentence_transformers <span class="im">import</span> SentenceTransformer</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>embeddingModelName <span class="op">=</span> <span class="st">"all-MiniLM-L6-v2"</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>sentenceModel <span class="op">=</span> SentenceTransformer(embeddingModelName)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>outputDim <span class="op">=</span> sentenceModel.get_sentence_embedding_dimension()</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of embedding dimensions: </span><span class="sc">{</span>outputDim<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> [</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"I love plants!"</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"More wine. Give me more! This wine is amazing for $500"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"It is possible to commit no mistakes and still lose. That is not a weakness. That is life."</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"I love sentence embeddings. We need more."</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>textEmbeddings <span class="op">=</span> sentenceModel.encode(text, normalize_embeddings <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Number of embedding dimensions: 384</code></pre>
</div>
</div>
<div class="cell" data-execution_count="12">
<details>
<summary>Code: plot embedding vectors</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> curve_fit</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaussian(x, mu, sigma, a):</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">*</span>np.exp(<span class="op">-</span><span class="fl">0.5</span><span class="op">*</span>(x<span class="op">-</span>mu)<span class="op">**</span><span class="dv">2</span><span class="op">/</span>sigma<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Figures:</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>fig,(ax1,ax2) <span class="op">=</span> plt.subplots(<span class="dv">2</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">8</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Subplot 1: scatter plot of embeddings</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, embedding <span class="kw">in</span> <span class="bu">enumerate</span>(textEmbeddings):</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    ax1.scatter(<span class="bu">list</span>(<span class="bu">range</span>(outputDim)), embedding, s <span class="op">=</span> <span class="dv">1</span>, label<span class="op">=</span>text[i])</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>ax1.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"Output vector index"</span>, ylabel<span class="op">=</span><span class="st">'Embedding value'</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>ax1.legend()</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>ax1.set_ylim(np.<span class="bu">min</span>(textEmbeddings)<span class="op">-</span><span class="fl">0.1</span>, np.<span class="bu">max</span>(textEmbeddings) <span class="op">+</span> <span class="fl">0.3</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Subplot 2: histogram of values and a gaussian fit.</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>textEmbeddings <span class="op">=</span> [t <span class="cf">for</span> t <span class="kw">in</span> textEmbeddings] <span class="co"># Funny pixel tv without.</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> ax2.hist(textEmbeddings, bins<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, stacked<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>xdata <span class="op">=</span> h[<span class="dv">1</span>][<span class="dv">1</span>:] <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span>np.diff(h[<span class="dv">1</span>])[<span class="dv">0</span>] <span class="co"># get center from bin edges.</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>ydata <span class="op">=</span> h[<span class="dv">0</span>][<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>popt, pcov <span class="op">=</span> curve_fit(gaussian, xdata, ydata, p0<span class="op">=</span>(<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="dv">100</span>))</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>SIGMA_ST <span class="op">=</span> popt[<span class="dv">1</span>]</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>ax2.plot(xdata, gaussian(xdata, <span class="op">*</span>popt), </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>         <span class="st">'r-'</span>, </span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="vs">r'Gaussian: $\mu$=</span><span class="sc">%5.5f</span><span class="vs">, $\sigma$=</span><span class="sc">%5.5f</span><span class="vs">'</span> <span class="op">%</span> <span class="bu">tuple</span>(np.<span class="bu">abs</span>(popt[<span class="dv">0</span>:<span class="dv">2</span>])))</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>ax2.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">'Embedding value'</span>, ylabel <span class="op">=</span> <span class="st">'Count'</span>)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(hspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The normalized embedding vectors look quite Gaussian. This is useful to know since models like SVM need the feature vectors to be scaled to unity.</p>
<p>Here’s an example of calculating the cosine similarities for each combination of sentence embeddings. There are four wine reviews with positive and negative price sentiments. There is also one quote from Picard, which is clearly dissimilar to the wine reviews.</p>
<div class="cell" data-execution_count="13">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 20%">
<col style="width: 80%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Tick Label</th>
<th style="text-align: left;">Text</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">wine-pos1</td>
<td style="text-align: left;">Great value cab - locally $10.50</td>
</tr>
<tr class="even">
<td style="text-align: left;">wine-pos2</td>
<td style="text-align: left;">A dark berry nose and deep berry flavor on the top. Blackberries it tells me. A blend that defies the pricing at under $20. A robust hit of smoky oak with a decent finish not usually found in this price range! Can you tell I like it?</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wine-neg1</td>
<td style="text-align: left;">A little lighter than expected, not in a good way. $16 is apparently overpriced. Would not seek out.</td>
</tr>
<tr class="even">
<td style="text-align: left;">wine-neg2</td>
<td style="text-align: left;">Actually not a bad wine but for the $56 we paid for it i can think of many more better wines. Nice after taste but dry.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">picard</td>
<td style="text-align: left;">It is possible to commit no mistakes and still lose. That is not a weakness. That is life.</td>
</tr>
<tr class="even">
<td style="text-align: left;">plants</td>
<td style="text-align: left;">I love plants!</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
</section>
<section id="part-6-preparing-data" class="level1">
<h1>Part 6: Preparing Data</h1>
<section id="training-data" class="level2">
<h2 class="anchored" data-anchor-id="training-data">Training Data</h2>
<p>The review text needs to be transformed into embeddings. These embeddings are used repeatedly for all our models and should only be transformed once.</p>
<p>I will be using two features:</p>
<ul>
<li>Review text</li>
<li>Star ratings</li>
</ul>
<section id="read-and-re-label-data" class="level4">
<h4 class="anchored" data-anchor-id="read-and-re-label-data">1. Read and re-label data</h4>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Read and re-label data set</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>rewriteDict <span class="op">=</span> {</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Positive'</span>: <span class="st">'Positive'</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Neutral'</span>: <span class="st">'Negative'</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Negative'</span>: <span class="st">'Negative'</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Don't know"</span>: <span class="st">"Don't know"</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(filename, encoding<span class="op">=</span><span class="st">'utf-8-sig'</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[[<span class="st">'reviews'</span>,<span class="st">'sentiment'</span>, <span class="st">'rating'</span>]]</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'sentiment'</span>] <span class="op">=</span> df[<span class="st">'sentiment'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: rewriteDict[x]) <span class="co"># Re-label 'Neutral' as 'Negative</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="16">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="clean-review-text" class="level4">
<h4 class="anchored" data-anchor-id="clean-review-text">2. Clean review text</h4>
<div class="cell" data-execution_count="17">
<details>
<summary>Code: Text cleaning functions</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> emoji</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_emoji(s):</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Useful emoji ripper</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> emoji.replace_emoji(s)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_excess_and_newline(s):</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Removes excessive fullstops (periods)..., !, and newlines.</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"\n"</span>, <span class="st">' '</span>, s)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"\.+"</span>, <span class="st">'.'</span>, s)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"!+"</span>, <span class="st">'!'</span>, s)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filter_characters(s):</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Only permit the follow characters in reviews. </span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mainly deletes unwanted symbols such as: (){}#@^&amp;*</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"[^a-zA-Z\d\s'’$\.!\-?£€,:éè%/]"</span>, <span class="st">''</span>, s)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fix_whitespace_around_punctuation(s):</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Many reviews have incorrect punc "wine,try", "wine.try", "wine .try"</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r","</span>, <span class="st">', '</span>, s)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r" ,"</span>, <span class="st">','</span>, s)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r" \."</span>, <span class="st">'.'</span>, s)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"(?&lt;=[.,!?])(?=[^\s\d])"</span>, <span class="st">' '</span>, s)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"(\s)(?=[.,!])"</span>, <span class="st">''</span>, s)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">#s = re.sub(r" !", '!', s)</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strip_extra_whitespace(s):</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Strip 2+ whitespaces</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="st">"\s+"</span>,<span class="st">' '</span>,s)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_text(s):</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> remove_emoji(s)</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> remove_excess_and_newline(s)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> filter_characters(s)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> fix_whitespace_around_punctuation(s)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> strip_extra_whitespace(s)</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'reviews_clean'</span>] <span class="op">=</span> df[<span class="st">'reviews'</span>].<span class="bu">apply</span>(clean_text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are some examples of the cleaned text.</p>
<div class="cell" data-execution_count="19">
<div class="cell-output cell-output-display" data-execution_count="19">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Review</th>
<th style="text-align: left;">Pre-processed Review</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Loved !!!! Pairs great with a 50$ steak lol or alone;)</td>
<td style="text-align: left;">Loved! Pairs great with a 50$ steak lol or alone</td>
</tr>
<tr class="even">
<td style="text-align: left;">Super soft mouth feel.. fruit forward. Not sure it’s worth the $50.00 but could be my pallet..</td>
<td style="text-align: left;">Super soft mouth feel. fruit forward. Not sure it’s worth the $50.00 but could be my pallet.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Heavy cherries on the nose , followed by a blackberry taste and spicy velvety smooth finish! More of a light-medium Cabernet and for the money, under $20……wow!!! Good wine 🍷 anytime!</td>
<td style="text-align: left;">Heavy cherries on the nose, followed by a blackberry taste and spicy velvety smooth finish! More of a light-medium Cabernet and for the money, under $20. wow! Good wine anytime!</td>
</tr>
<tr class="even">
<td style="text-align: left;">3.7 ~ 87% ($14.75) Frescobaldi 🇮🇹 Rèmole Rosso 2017 Med bodied, bruised, rustic purple ~ black berries, red cherries, and plums ~ smooth as always ~ spicy, oaky, and dry (4 gs/12.5% abv). I had the patience of a Buddhist monk, and let this one stew in my bat cave for THREE years! It didn’t really seem to help 😑</td>
<td style="text-align: left;">3.7 87% $14.75 Frescobaldi Rèmole Rosso 2017 Med bodied, bruised, rustic purple black berries, red cherries, and plums smooth as always spicy, oaky, and dry 4 gs/12.5% abv. I had the patience of a Buddhist monk, and let this one stew in my bat cave for THREE years! It didn’t really seem to help</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="normalize-star-ratings-since-many-models-require-feature-scaling" class="level4">
<h4 class="anchored" data-anchor-id="normalize-star-ratings-since-many-models-require-feature-scaling">3. Normalize star-ratings since many models require feature scaling</h4>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'norm_rating'</span>] <span class="op">=</span> (df[<span class="st">'rating'</span>] <span class="op">-</span> <span class="fl">3.0</span>) <span class="op">*</span> <span class="fl">0.5</span>  <span class="co"># Normalize 5-star rating</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="split-data-training-and-test-sets" class="level4">
<h4 class="anchored" data-anchor-id="split-data-training-and-test-sets">4. Split data: training and test sets</h4>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>seed <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>splitFraction <span class="op">=</span> <span class="fl">0.85</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                                                    df, </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                                                    df[<span class="st">'sentiment'</span>], </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                                                    train_size<span class="op">=</span>splitFraction, </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                                                    random_state<span class="op">=</span>seed)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Training set size: </span><span class="sc">{</span><span class="bu">len</span>(X_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Testing set size: </span><span class="sc">{</span><span class="bu">len</span>(X_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training set size: 4722
Testing set size: 834</code></pre>
</div>
</div>
</section>
<section id="imbalanced-data-and-class-weights" class="level4">
<h4 class="anchored" data-anchor-id="imbalanced-data-and-class-weights">5. Imbalanced data and class-weights</h4>
<p>A common solution to imbalanced data is to under- or oversample until the class frequencies are equal. Under-sampling throws out data and reduces the diversity in majority classes. Oversampling duplicates random samples from the minority classes and increases computation time when machine learning.</p>
<p>I prefer re-weighting the loss function by the class weights, which works for most models. Its effectively the same as oversampling without the computational expense and random sampling.</p>
<p>Another really interesting solution is to do sentence augmentation which is oversampling plus a rearrangement of the sentences. This is more applicable considering most sentences are disjoint from others in a short review. This is a work in progress that I will revisit! For now, I stick with class re-weighting.</p>
<div class="cell" data-execution_count="22">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.utils.class_weight <span class="im">import</span> compute_sample_weight, compute_class_weight</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>sample_weight <span class="op">=</span> compute_sample_weight(class_weight <span class="op">=</span> <span class="st">'balanced'</span>, y <span class="op">=</span> y_train)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>class_name <span class="op">=</span> y_train.unique()</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>class_weight <span class="op">=</span> compute_class_weight(class_weight <span class="op">=</span> <span class="st">'balanced'</span>, classes<span class="op">=</span>class_name, y <span class="op">=</span> y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
</section>
<section id="model-fits" class="level1">
<h1>Model Fits</h1>
<p>There are 5,500 samples of data with three imbalanced labels distributed approximately into 6/2/1 parts. Each piece of data has ~400 normalized features. This gives us roughly ~10x data points per input dimension, which is pretty good!</p>
<p>There are several machine learning algorithms that we can try. I’ll try the following below.</p>
<ul>
<li>Dummy Classifier</li>
<li>Logistic Regression</li>
<li>(Complement) Naive Bayes</li>
<li>SVMs</li>
<li>Random Forests</li>
<li>Stochastic Gradient Boosting</li>
</ul>
<p>Neural networks are unlikely to work since we need approximately 10 pieces of data per free variable. Our input layer has ~400 dimensions, which is practically all our data. I will try anyways at a later date!</p>
<section id="column-transformers-pipelines-and-cross-validation" class="level4">
<h4 class="anchored" data-anchor-id="column-transformers-pipelines-and-cross-validation">Column Transformers, Pipelines, and Cross Validation</h4>
<p>A network of pipes connect the raw data to various transformers where features from the data are engineered. Once complete, the transformed data is sent to a classifier or regressor. We first need to define the transformers before defining the pipes connecting between them.</p>
<p>Normally, the sentence embeddings would be precomputed so you don’t recompute them each time. I have a pretty good GPU that computes the embeddings in about one second. So, I’ll add the encoder as a transformer in the pipeline as an exercise.</p>
<p>We need to define a column transformer that selects the reviews and ratings from the training set. The CT applies transformers to specified data columns separately. The outputs of these individual transformers are concatenated into one output and passed along.</p>
<p>Finally, we’ll use 10-folds for cross validation.</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, TransformerMixin</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.dummy <span class="im">import</span> DummyClassifier</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SBERTEncoder(BaseEstimator, TransformerMixin):</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, X):</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        embeddings <span class="op">=</span> sentenceModel.encode(<span class="bu">list</span>(X.iloc[:,<span class="dv">0</span>]), normalize_embeddings <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize by pre-computed mean and std of embeddings.</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        embeddings <span class="op">=</span> embeddings <span class="op">-</span> ST_MEAN</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        embeddings <span class="op">/=</span> ST_STD</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> embeddings</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>SelectorTransformer <span class="op">=</span> ColumnTransformer([</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'SentenceEmbeddings_transformer'</span>, SBERTEncoder(), [<span class="st">'reviews'</span>] ),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'NormalizedRatings_transformer'</span>, <span class="st">'passthrough'</span>, [<span class="st">'norm_rating'</span>]),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a.-dummy-classifier" class="level2">
<h2 class="anchored" data-anchor-id="a.-dummy-classifier">A. Dummy Classifier</h2>
<p>The dummy classifier ignores input features. “Stratified” predicts based on the occurrence frequency of classes from the training set. Our custom weighted score is also shown. This is our baseline.</p>
<div class="cell" data-execution_count="91">
<details open="">
<summary>Model: Dummy Classifier</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.dummy <span class="im">import</span> DummyClassifier</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>dc_pipe <span class="op">=</span> Pipeline([</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'SelectorTransformer'</span>, SelectorTransformer),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'DummyClassifier'</span>, DummyClassifier(strategy<span class="op">=</span><span class="st">"stratified"</span>)), </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>dummy_model <span class="op">=</span> dc_pipe</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>dummy_model.fit(X_train, y_train) </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>GenerateReport(dummy_model, X_test, y_test)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> fdir_model <span class="op">+</span> <span class="st">'DummyClassifier.dill'</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>dill.dump(dummy_model, <span class="bu">open</span>(fname, <span class="st">'wb'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>----&gt; Custom weighted score: 0.3680 &lt;----
                             ^^^^^^
              precision    recall  f1-score   support

  Don't know       0.14      0.15      0.14       118
    Negative       0.27      0.23      0.25       225
    Positive       0.58      0.60      0.59       491

    accuracy                           0.44       834
   macro avg       0.33      0.33      0.33       834
weighted avg       0.43      0.44      0.44       834
</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-28-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="b.-logistic-regression" class="level2">
<h2 class="anchored" data-anchor-id="b.-logistic-regression">B. Logistic Regression</h2>
<p>Basic logistic function with L2 regularization.</p>
<div class="cell" data-execution_count="104">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>lr_pipe <span class="op">=</span> Pipeline([</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'SelectorTransformer'</span>, SelectorTransformer),</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'LogisticRegression'</span>, LogisticRegression(max_iter<span class="op">=</span><span class="dv">10000</span>)), </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>lr_gs <span class="op">=</span> GridSearchCV(lr_pipe, </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                     param_grid <span class="op">=</span> {<span class="st">"LogisticRegression__C"</span>: <span class="dv">10</span><span class="op">**</span>np.arange(<span class="op">-</span><span class="dv">2</span>,<span class="dv">2</span><span class="op">+</span><span class="fl">0.25</span>, <span class="fl">0.25</span>)},</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                     cv <span class="op">=</span> kfolds,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                     n_jobs<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                     scoring <span class="op">=</span> sentimentScorer,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>lr_gs.fit(X_train, y_train, LogisticRegression__sample_weight<span class="op">=</span>sample_weight) </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> lr_gs</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The best hyperparameter value is: "</span>, model.best_params_)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>GenerateReport(model, X_test, y_test)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> fdir_model <span class="op">+</span> <span class="st">'LogisticRegression.dill'</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>dill.dump(model, <span class="bu">open</span>(fname, <span class="st">'wb'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The best hyperparameter value is:  {'LogisticRegression__C': 0.01778279410038923}
----&gt; Custom weighted score: 0.7078 &lt;----
                             ^^^^^^
              precision    recall  f1-score   support

  Don't know       0.37      0.61      0.46       118
    Negative       0.69      0.68      0.69       225
    Positive       0.85      0.72      0.78       491

    accuracy                           0.69       834
   macro avg       0.64      0.67      0.64       834
weighted avg       0.74      0.69      0.71       834
</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-29-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="c.-complement-naive-bayes" class="level2">
<h2 class="anchored" data-anchor-id="c.-complement-naive-bayes">C. Complement Naive Bayes</h2>
<p>The input to Multinomial Naive Bayes must be positive. We can achieve this by rescaling all the features to be between 0 and 1 using MinMaxScaler(). Complement Naive Bayes is apparently the corrected version of MNB when there is imbalanced data.</p>
<div class="cell" data-execution_count="46">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.naive_bayes <span class="im">import</span> ComplementNB</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> MinMaxScaler</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>cnb_pipe <span class="op">=</span> Pipeline([</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'SelectorTransformer'</span>, SelectorTransformer),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'MinMaxScaler'</span>, MinMaxScaler()),</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'ComplementNB'</span>, ComplementNB()), </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>cnb_gs <span class="op">=</span> GridSearchCV(cnb_pipe, </span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>                     param_grid <span class="op">=</span> {<span class="st">"ComplementNB__alpha"</span>: <span class="dv">10</span><span class="op">**</span>np.arange(<span class="dv">0</span>,<span class="dv">3</span><span class="op">+</span><span class="fl">0.25</span>, <span class="fl">0.25</span>)},</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>                     cv <span class="op">=</span> kfolds,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>                     n_jobs<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>                     scoring <span class="op">=</span> sentimentScorer,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>cnb_gs.fit(X_train, y_train, ComplementNB__sample_weight<span class="op">=</span>sample_weight) </span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> cnb_gs</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The best hyperparameter value is: "</span>, model.best_params_)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>GenerateReport(model, X_test, y_test)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> fdir_model <span class="op">+</span> <span class="st">'ComplementNB.dill'</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>dill.dump(model, <span class="bu">open</span>(fname, <span class="st">'wb'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The best hyperparameter value is:  {'ComplementNB__alpha': 1000.0}
----&gt; Custom weighted score: 0.6566 &lt;----
                             ^^^^^^
              precision    recall  f1-score   support

  Don't know       0.32      0.54      0.40       118
    Negative       0.67      0.65      0.66       225
    Positive       0.77      0.65      0.71       491

    accuracy                           0.64       834
   macro avg       0.59      0.62      0.59       834
weighted avg       0.68      0.64      0.65       834
</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-30-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="d.-support-vector-machine" class="level2">
<h2 class="anchored" data-anchor-id="d.-support-vector-machine">D. Support Vector Machine</h2>
<p>SVM attempts to draw boundaries between classes of points using hypersurfaces. Each surface has a margin or “thickness” where points inside the margin become ‘support vectors’ which, in fact, define the hyper surface.</p>
<p>The amount of “slack” given to a proposed hypersurface is defined by points located on the wrong side of the hypersurface. The total slack is quantified by the sum of distance (or whatever penalty you define) between these points to the surface. A regularization parameter is used to control the strength of a penalty applied from slack. This is defined as <em>C</em> in the following code.</p>
<p>The hypersurface is a hyperplane (i.e., linear) by default. A kernel trick is used to allow malleable surfaces. I will explore a number of kernels which have their own hyperparameters (e.g., dimension of polynomial).</p>
<div class="cell" data-execution_count="59">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.svm <span class="im">import</span> SVC</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>C_param <span class="op">=</span> <span class="dv">10</span><span class="op">**</span>np.arange(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span><span class="op">+</span><span class="fl">0.5</span>, <span class="fl">0.5</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> [</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'SVC__kernel'</span>: [<span class="st">'poly'</span>], <span class="st">'SVC__degree'</span>: [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>], <span class="st">'SVC__C'</span>: C_param},</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'SVC__kernel'</span>:  [<span class="st">'rbf'</span>], <span class="st">'SVC__C'</span>: C_param},</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'SVC__kernel'</span>: [<span class="st">'sigmoid'</span>], <span class="st">'SVC__C'</span>: C_param}</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>svc_pipe <span class="op">=</span> Pipeline([</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'SelectorTransformer'</span>, SelectorTransformer),</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'SVC'</span>, SVC(class_weight<span class="op">=</span><span class="st">'balanced'</span>, cache_size<span class="op">=</span><span class="dv">2000</span>, random_state<span class="op">=</span><span class="dv">42</span>)), <span class="co"># Can choose a balanced class weighting. </span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>svc_gs <span class="op">=</span> GridSearchCV(svc_pipe, </span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>                     param_grid <span class="op">=</span> param_grid,</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>                     cv <span class="op">=</span> kfolds,</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>                     n_jobs<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>                     scoring <span class="op">=</span> sentimentScorer,</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>svc_gs.fit(X_train, y_train) </span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> svc_gs</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The best hyperparameter value is: "</span>, model.best_params_)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>GenerateReport(model, X_test, y_test)</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> fdir_model <span class="op">+</span> <span class="st">'SVC.dill'</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>dill.dump(model, <span class="bu">open</span>(fname, <span class="st">'wb'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The best hyperparameter value is:  {'SVC__C': 1.0, 'SVC__degree': 2, 'SVC__kernel': 'poly'}
----&gt; Custom weighted score: 0.7125 &lt;----
                             ^^^^^^
              precision    recall  f1-score   support

  Don't know       0.42      0.55      0.48       118
    Negative       0.70      0.71      0.71       225
    Positive       0.83      0.77      0.80       491

    accuracy                           0.72       834
   macro avg       0.65      0.68      0.66       834
weighted avg       0.74      0.72      0.73       834
</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-31-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="e.-random-forest" class="level2">
<h2 class="anchored" data-anchor-id="e.-random-forest">E. Random Forest</h2>
<p>There are many parameters in a decision tree and many more when aggregating over a forest of decision trees. Here are all of the relevant parameters we can change:</p>
<div class="cell" data-execution_count="64">
<div class="cell-output cell-output-display" data-execution_count="64">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n_estimators</td>
<td style="text-align: left;">The number of trees in the forest.</td>
</tr>
<tr class="even">
<td style="text-align: left;">max_depth</td>
<td style="text-align: left;">The maximum depth of tree from the root.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">min_samples_split</td>
<td style="text-align: left;">Minimum number of samples required for a split to be considered.</td>
</tr>
<tr class="even">
<td style="text-align: left;">min_samples_leaf</td>
<td style="text-align: left;">Minimum number of samples required for each leaf.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">max_features</td>
<td style="text-align: left;">The number of features to consider when choosing a split for an internal node.</td>
</tr>
<tr class="even">
<td style="text-align: left;">bootstrap</td>
<td style="text-align: left;">Whether bootstrap samples are used when building trees.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">oob_score</td>
<td style="text-align: left;">Whether to use out-of-bag samples to estimate the generalization accuracy.</td>
</tr>
<tr class="even">
<td style="text-align: left;">n_jobs</td>
<td style="text-align: left;">The number of jobs to run in parallel for both fit and predict. If -1, then the number of jobs is set to the number of cores.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.svm <span class="im">import</span> SVC</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>C_param <span class="op">=</span> <span class="dv">10</span><span class="op">**</span>np.arange(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span><span class="op">+</span><span class="fl">0.5</span>, <span class="fl">0.5</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> [</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'SVC__kernel'</span>: [<span class="st">'poly'</span>], <span class="st">'SVC__degree'</span>: [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>], <span class="st">'SVC__C'</span>: C_param},</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'SVC__kernel'</span>:  [<span class="st">'rbf'</span>], <span class="st">'SVC__C'</span>: C_param},</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'SVC__kernel'</span>: [<span class="st">'sigmoid'</span>], <span class="st">'SVC__C'</span>: C_param}</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>svc_pipe <span class="op">=</span> Pipeline([</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'SelectorTransformer'</span>, SelectorTransformer),</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'SVC'</span>, SVC(class_weight<span class="op">=</span><span class="st">'balanced'</span>, cache_size<span class="op">=</span><span class="dv">2000</span>, random_state<span class="op">=</span><span class="dv">42</span>)), <span class="co"># Can choose a balanced class weighting. </span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>svc_gs <span class="op">=</span> GridSearchCV(svc_pipe, </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>                     param_grid <span class="op">=</span> param_grid,</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>                     cv <span class="op">=</span> kfolds,</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>                     n_jobs<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>                     scoring <span class="op">=</span> sentimentScorer,</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>svc_gs.fit(X_train, y_train) </span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> svc_gs</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The best hyperparameter value is: "</span>, model.best_params_)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>GenerateReport(model, X_test, y_test)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> fdir_model <span class="op">+</span> <span class="st">'SVC.dill'</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>dill.dump(model, <span class="bu">open</span>(fname, <span class="st">'wb'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="pipelines" class="level2">
<h2 class="anchored" data-anchor-id="pipelines">Pipelines</h2>
<p>A network of pipes connect the raw data to various transformers where features from the data are engineered. Once complete, the transformed data is sent to a classifier or regressor. We first need to define the transformers before defining the pipes connecting between them.</p>
<p><strong>Step 1a:</strong> Define a transformer that pre-processes text. In this case, I want to prune text to best match embedding model’s <a href="https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2">training corpus</a>, which were predominantly Reddit comments, article abstracts, and WikiAnswers. The reviews often have incorrect/strange punctuation, missing/excessive white spaces, and emojis. Here is a list of functions to tackle these issues.</p>
<p><strong>Step 1b:</strong> Define a transformer that encodes review text into sentence embeddings.</p>
<div class="cell" data-execution_count="22">
<details>
<summary>Code: SBERT encoder</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SBERTEncoder(BaseEstimator, TransformerMixin):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, X):</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># X - pandas series of text</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        embeddings <span class="op">=</span> sentenceModel.encode(<span class="bu">list</span>(X.iloc[:,<span class="dv">0</span>]), normalize_embeddings <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize by the best fit STD: SIGMA_ST </span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        embeddings <span class="op">/=</span> SIGMA_ST</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> embeddings</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Step 3:</strong> Define a pipeline and specify the classifier. This is where you can experiment with several classifiers to test. Here’s an example of a pipeline below with a Gradient Boosting Classifier. More on this in Part 6!</p>
<div class="cell" data-execution_count="17">
<details>
<summary>Code: Sample pipeline</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> KNeighborsClassifier</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>gbc_pipe <span class="op">=</span> Pipeline([</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'SBERTRatingTransformer'</span>, SBERTRatingTransformer),</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'KNeighborsClassifier'</span>, KNeighborsClassifier(n_jobs<span class="op">=</span><span class="dv">8</span>)),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="24">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(dirIn<span class="op">+</span><span class="st">"unlabelled_surveys.csv"</span>, encoding<span class="op">=</span><span class="st">"utf-8-sig"</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(df[df[<span class="st">'rating'</span>]<span class="op">&gt;=</span><span class="fl">4.5</span>][<span class="st">'rating'</span>])<span class="op">/</span><span class="bu">len</span>(df[df[<span class="st">'rating'</span>]<span class="op">&lt;=</span><span class="fl">1.5</span>][<span class="st">'rating'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>21.236842105263158</code></pre>
</div>
</div>
<div class="cell" data-execution_count="26">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>dirIn <span class="op">=</span> <span class="st">"D:</span><span class="ch">\\</span><span class="st">vivino_data</span><span class="ch">\\</span><span class="st">survey_results</span><span class="ch">\\</span><span class="st">"</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> dirIn <span class="op">+</span> <span class="st">"all_labelled_surveys.csv"</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>df_new <span class="op">=</span> pd.read_csv(filename, encoding<span class="op">=</span><span class="st">'utf-8-sig'</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>dirIn <span class="op">=</span> <span class="st">"D:</span><span class="ch">\\</span><span class="st">vivino_data</span><span class="ch">\\</span><span class="st">survey_results</span><span class="ch">\\</span><span class="st">"</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> dirIn <span class="op">+</span> <span class="st">"labelled_surveys_no_ratings.csv"</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>df_old <span class="op">=</span> pd.read_csv(filename, encoding<span class="op">=</span><span class="st">'utf-8-sig'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="27">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.concat([df_new,df_old],ignore_index<span class="op">=</span><span class="va">True</span>)[[<span class="st">'reviews'</span>,<span class="st">'sentiment'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="28">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>df[df[<span class="st">'sentiment'</span>]<span class="op">==</span><span class="st">"Don't know"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="28">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">reviews</th>
<th data-quarto-table-cell-role="th">sentiment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Gotta love Christmas dinner where the uncles w...</td>
<td>Don't know</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>Full bodied, flavorful from start to finish, n...</td>
<td>Don't know</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9</td>
<td>Incredible for the price, good celebratory win...</td>
<td>Don't know</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>At the Palm Restaurant. $100\nHeb = 36\nCostco...</td>
<td>Don't know</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>Expensive but had to be done once in my life. ...</td>
<td>Don't know</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6126</td>
<td>Med body, balanced acid, fruit, light tannin. ...</td>
<td>Don't know</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6139</td>
<td>84 Not sure how many bottles of this Wine Enth...</td>
<td>Don't know</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6153</td>
<td>$19.99 in Safeway.</td>
<td>Don't know</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6165</td>
<td>14.5% and $25. Really nice wine. Dry with righ...</td>
<td>Don't know</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6166</td>
<td>Great flavor, smooth almost sweet, pairs amazi...</td>
<td>Don't know</td>
</tr>
</tbody>
</table>

<p>719 rows × 2 columns</p>
</div>
</div>
</div>
<p>Business model</p>
<p>If each category is mislabelled incorrectly by the same amount then no one’s the wiser. If the model preferentially classifies positives as negative then the distribution of sentiment-ratios shifts down. This has at least two potential effects:</p>
<ol type="1">
<li>Bottles with fewer reviews will suffer more. Since most bottles have fewer reviews, our pool of bottle recommendations decreases which may shorten the lifetime of the app. That’s not great.</li>
<li>The liquor store may be unfairly judged more poorly due to their prices being perceived more poorly. Our liquor distribution and sales are primarily run by the government. So, the profit goes back to the government and, nominally, the citizens. I’d be surprised if my app had that effect that.</li>
</ol>
<p>On the other hand, if negatives are misclassified as positive then (1) the pool of bottle recommendations increases and (2) the average quality decreases. Thus, users are more likely to buy crappier wines.</p>
<p>Okay, enough speculations. A solution is to cut away the pool of bottles with fewer reviews since they have higher sensititivities to our model’s performance.</p>
<p>If the two missclassification directions are quite unequal, I’d prefer having a more discriminating recommender system. My goal is to recommend wines that are genuinely good and well-priced. If they’re comparable</p>
<p>A small complication is that DKs can be falsely classified as positive or negative and the proportions need not be equal. The distribution of DKs across star rating is somewhat uniform with a lean towards high-star ratings, which correlates with positive sentiment. This leads to more DKs falsely labelled as positive than negative. This is good news since the impact to the recommendation is relatively nerfed when adding noise to positives because they are counted in both the numerator and denominator in the sentiment-ratio (since positives are counted in both).</p>
<section id="sentence-augmentation" class="level4">
<h4 class="anchored" data-anchor-id="sentence-augmentation">3. Sentence Augmentation</h4>
<p>There are several strategies to dealing with imbalanced data sets. The most common are under and oversampling (i.e., duplicate minority data or throw out majority data). You can also define the sample or class weights to place emphasis.</p>
<p>For natural language problems, we can employ sentence augmentation where sentences in a review are re-arranged. Here’s an example with one statement rearranged twice.</p>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>textSamples <span class="op">=</span> [</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"I love this for $5. Let it open for a minute and then its a lovely burst of blueberry."</span>, </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Let it open for a minute and then its a lovely burst of blueberry. I love this for $5."</span>]</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>emb <span class="op">=</span> sentenceModel.encode(textSamples, normalize_embeddings<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'(A) </span><span class="sc">{</span>textSamples[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'(B) </span><span class="sc">{</span>textSamples[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cosine similarity of (A) and (A): </span><span class="sc">{</span>np<span class="sc">.</span>dot(emb[<span class="dv">0</span>],emb[<span class="dv">0</span>])<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cosine similarity of (A) and (B): </span><span class="sc">{</span>np<span class="sc">.</span>dot(emb[<span class="dv">0</span>],emb[<span class="dv">1</span>])<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(A) I love this for $5. Let it open for a minute and then its a lovely burst of blueberry.
(B) Let it open for a minute and then its a lovely burst of blueberry. I love this for $5.
Cosine similarity of (A) and (A): 1.0
Cosine similarity of (A) and (B): 0.9086364507675171</code></pre>
</div>
</div>


</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This includes using a BERT sentence transformer which benefits from context.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{ro2023,
  author = {Ro, Stephen},
  title = {Price-Sentiment {Analysis} {Model} Using {BERT}},
  date = {2023-07-06},
  url = {https://royourboat.github.io/posts/2023-07-10-sentence-embedding/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-ro2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Ro, Stephen. 2023. <span>“Price-Sentiment Analysis Model Using
BERT.”</span> July 6, 2023. <a href="https://royourboat.github.io/posts/2023-07-10-sentence-embedding/">https://royourboat.github.io/posts/2023-07-10-sentence-embedding/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>