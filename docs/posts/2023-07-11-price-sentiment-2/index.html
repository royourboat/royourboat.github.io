<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stephen Ro">
<meta name="dcterms.date" content="2023-07-11">
<meta name="description" content="Using both context (SBERT) and keywords (TF-IDF) with XGBoost">

<title>Stephen Ro - Judging Wine Prices: Selecting a Model (Part 2)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Stephen Ro</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume/Stephen_Ro_Resume.pdf" rel="" target="">
 <span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/royourboat" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/stephenro/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:stephensro@gmail.com" rel="" target=""><i class="bi bi-envelope" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Judging Wine Prices: Selecting a Model (Part 2)</h1>
                  <div>
        <div class="description">
          Using both context (SBERT) and keywords (TF-IDF) with XGBoost
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Python</div>
                <div class="quarto-category">JSON</div>
                <div class="quarto-category">BERT</div>
                <div class="quarto-category">NLP</div>
                <div class="quarto-category">machine-learning</div>
                <div class="quarto-category">sklearn</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://royourboat.github.io/">Stephen Ro</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 11, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#reminder" id="toc-reminder" class="nav-link active" data-scroll-target="#reminder">Reminder</a></li>
  <li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering">Feature Engineering</a>
  <ul class="collapse">
  <li><a href="#training-data" id="toc-training-data" class="nav-link" data-scroll-target="#training-data">Training Data</a></li>
  </ul></li>
  <li><a href="#model-fits" id="toc-model-fits" class="nav-link" data-scroll-target="#model-fits">Model Fits</a></li>
  <li><a href="#model-results" id="toc-model-results" class="nav-link" data-scroll-target="#model-results">Model Results</a>
  <ul class="collapse">
  <li><a href="#logistic-regression" id="toc-logistic-regression" class="nav-link" data-scroll-target="#logistic-regression">1. Logistic Regression</a></li>
  <li><a href="#complement-naive-bayes" id="toc-complement-naive-bayes" class="nav-link" data-scroll-target="#complement-naive-bayes">2. Complement Naive Bayes</a></li>
  <li><a href="#support-vector-machine" id="toc-support-vector-machine" class="nav-link" data-scroll-target="#support-vector-machine">3. Support Vector Machine</a></li>
  <li><a href="#random-forest-classifier" id="toc-random-forest-classifier" class="nav-link" data-scroll-target="#random-forest-classifier">4. Random Forest Classifier</a></li>
  <li><a href="#xgboost-winner" id="toc-xgboost-winner" class="nav-link" data-scroll-target="#xgboost-winner">5. XGBoost (Winner!)</a></li>
  <li><a href="#lightgbm" id="toc-lightgbm" class="nav-link" data-scroll-target="#lightgbm">6. LightGBM</a></li>
  </ul></li>
  <li><a href="#model-training-code" id="toc-model-training-code" class="nav-link" data-scroll-target="#model-training-code">Model Training Code</a>
  <ul class="collapse">
  <li><a href="#a.-dummy-classifier" id="toc-a.-dummy-classifier" class="nav-link" data-scroll-target="#a.-dummy-classifier">A. Dummy Classifier</a></li>
  <li><a href="#b.-logistic-regression" id="toc-b.-logistic-regression" class="nav-link" data-scroll-target="#b.-logistic-regression">B. Logistic Regression</a></li>
  <li><a href="#c.-complement-naive-bayes" id="toc-c.-complement-naive-bayes" class="nav-link" data-scroll-target="#c.-complement-naive-bayes">C. Complement Naive Bayes</a></li>
  <li><a href="#d.-support-vector-machine" id="toc-d.-support-vector-machine" class="nav-link" data-scroll-target="#d.-support-vector-machine">D. Support Vector Machine</a></li>
  <li><a href="#e.-random-forest" id="toc-e.-random-forest" class="nav-link" data-scroll-target="#e.-random-forest">E. Random Forest</a></li>
  <li><a href="#f.-xgboost" id="toc-f.-xgboost" class="nav-link" data-scroll-target="#f.-xgboost">F. XGBoost</a></li>
  <li><a href="#g.-lightgbm" id="toc-g.-lightgbm" class="nav-link" data-scroll-target="#g.-lightgbm">G. LightGBM</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="reminder" class="level1">
<h1>Reminder</h1>
<p>This is part two of a series where I train a machine learning model on price sentiment.</p>
<p>In part two, I’ll go over:</p>
<ul>
<li>Preparing the wine review data</li>
<li>Grid searching machine learning model candidates</li>
<li>Selecting the best performing model</li>
</ul>
<p>Check out <a href="../2023-07-10-price-sentiment/">part one</a> to learn about the training data.</p>
</section>
<section id="feature-engineering" class="level1">
<h1>Feature Engineering</h1>
<section id="training-data" class="level2">
<h2 class="anchored" data-anchor-id="training-data">Training Data</h2>
<p><img src="index_files/figure-html/23d3a634-1-2c75e76dad7c1e5ed7664841b6da7f29-1.png" class="img-fluid"></p>
<section id="read-and-re-label-data" class="level4">
<h4 class="anchored" data-anchor-id="read-and-re-label-data">1. Read and re-label data</h4>
<div class="cell" data-execution_count="2">
<details>
<summary>Code: Read and re-label ‘Neutral’ as ‘Negative’</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Read and re-label data set</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>rewriteDict <span class="op">=</span> {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Positive'</span>: <span class="st">'Positive'</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Neutral'</span>: <span class="st">'Negative'</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Negative'</span>: <span class="st">'Negative'</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Don't know"</span>: <span class="st">"Don't know"</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(filename, encoding<span class="op">=</span><span class="st">'utf-8-sig'</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[[<span class="st">'reviews'</span>,<span class="st">'sentiment'</span>, <span class="st">'rating'</span>]]</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'sentiment'</span>] <span class="op">=</span> df[<span class="st">'sentiment'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: rewriteDict[x]) <span class="co"># Re-label 'Neutral' as 'Negative</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="13">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="rescale-star-ratings-since-many-models-require-feature-scaling" class="level4">
<h4 class="anchored" data-anchor-id="rescale-star-ratings-since-many-models-require-feature-scaling">2. Rescale star-ratings since many models require feature scaling</h4>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="index_files/figure-html/36735152-1-71a9318aa9f51c6f637560690ff9c9df.png" class="img-fluid figure-img"></p>
</figure>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'unit_rating'</span>] <span class="op">=</span> (df[<span class="st">'rating'</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> <span class="dv">4</span>  <span class="co"># Normalize 5-star rating</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="filter-longer-reviews-1-from-training" class="level4">
<h4 class="anchored" data-anchor-id="filter-longer-reviews-1-from-training">3. Filter longer reviews (1%) from training</h4>
<p>Here is a log-histogram of word frequency per review that I made in this <a href="../2023-07-06-vivino-part1/">post</a>. The number of words per review cannot exceed a threshold since (a) the character limit per review is 520, and (b) the average characters per word is 4.79 (or 5.79 if you include a white space). This threshold is 520 / 5.79 ~ 90, which is approximately where the knee of the distribution is.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/89009b56-1-fig-words-output-1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">fig-words-output-1.png</figcaption>
</figure>
</div>
<p>From experiments, I found that filtering out reviews with more than 350 characters (roughly 60 average-length words) improved every model’s performance by a few percent. The price-sentiment takes relatively little estate in a review. So, sacrificing 1% of reviews is a small penalty for a 3% model improvement!</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'len'</span>] <span class="op">=</span> df[<span class="st">'reviews'</span>].<span class="bu">apply</span>(<span class="bu">len</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df[<span class="st">'len'</span>]<span class="op">&lt;=</span><span class="dv">350</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="strip-and-clean-review-text" class="level4">
<h4 class="anchored" data-anchor-id="strip-and-clean-review-text">4. Strip and clean review text</h4>
<div class="cell" data-execution_count="16">
<details>
<summary>Code: Text cleaning functions</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> emoji</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_emoji(s):</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Useful emoji ripper</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> emoji.replace_emoji(s)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_excess_and_newline(s):</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Removes excessive fullstops (periods)..., !, and newlines.</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"\n"</span>, <span class="st">' '</span>, s)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"\.+"</span>, <span class="st">'.'</span>, s)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"!+"</span>, <span class="st">'!'</span>, s)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filter_characters(s):</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Only permit the follow characters in reviews. </span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mainly deletes unwanted symbols such as: (){}#@^&amp;*</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"[^a-zA-Z\d\s'’$\.!\-?£€,:éè%/]"</span>, <span class="st">''</span>, s)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filter_only_characters(s):</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Only permit characters in reviews. </span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"[^a-zA-Z\s]"</span>, <span class="st">''</span>, s)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fix_whitespace_around_punctuation(s):</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Many reviews have incorrect punc "wine,try", "wine.try", "wine .try"</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r","</span>, <span class="st">', '</span>, s)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r" ,"</span>, <span class="st">','</span>, s)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r" \."</span>, <span class="st">'.'</span>, s)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"(?&lt;=[.,!?])(?=[^\s\d])"</span>, <span class="st">' '</span>, s)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"(\s)(?=[.,!])"</span>, <span class="st">''</span>, s)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#s = re.sub(r" !", '!', s)</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strip_extra_whitespace(s):</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Strip 2+ whitespaces</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="st">"\s+"</span>,<span class="st">' '</span>,s)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cleaned_text(s):</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> remove_emoji(s)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> remove_excess_and_newline(s)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> filter_characters(s)</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> fix_whitespace_around_punctuation(s)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> strip_extra_whitespace(s)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'reviews_clean'</span>] <span class="op">=</span> df[<span class="st">'reviews'</span>].<span class="bu">apply</span>(cleaned_text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\steph\AppData\Local\Temp\ipykernel_28044\1431066477.py:3: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df['reviews_clean'] = df['reviews'].apply(cleaned_text)</code></pre>
</div>
</div>
<p>Here are some examples of the cleaned text.</p>
<div class="cell" data-execution_count="19">
<div class="cell-output cell-output-display" data-execution_count="19">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Review</th>
<th style="text-align: left;">Pre-processed Review</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Loved !!!! Pairs great with a 50$ steak lol or alone;)</td>
<td style="text-align: left;">Loved! Pairs great with a 50$ steak lol or alone</td>
</tr>
<tr class="even">
<td style="text-align: left;">Super soft mouth feel.. fruit forward. Not sure it’s worth the $50.00 but could be my pallet..</td>
<td style="text-align: left;">Super soft mouth feel. fruit forward. Not sure it’s worth the $50.00 but could be my pallet.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Heavy cherries on the nose , followed by a blackberry taste and spicy velvety smooth finish! More of a light-medium Cabernet and for the money, under $20……wow!!! Good wine 🍷 anytime!</td>
<td style="text-align: left;">Heavy cherries on the nose, followed by a blackberry taste and spicy velvety smooth finish! More of a light-medium Cabernet and for the money, under $20. wow! Good wine anytime!</td>
</tr>
<tr class="even">
<td style="text-align: left;">3.7 ~ 87% ($14.75) Frescobaldi 🇮🇹 Rèmole Rosso 2017 Med bodied, bruised, rustic purple ~ black berries, red cherries, and plums ~ smooth as always ~ spicy, oaky, and dry (4 gs/12.5% abv). I had the patience of a Buddhist monk, and let this one stew in my bat cave for THREE years! It didn’t really seem to help 😑</td>
<td style="text-align: left;">3.7 87% $14.75 Frescobaldi Rèmole Rosso 2017 Med bodied, bruised, rustic purple black berries, red cherries, and plums smooth as always spicy, oaky, and dry 4 gs/12.5% abv. I had the patience of a Buddhist monk, and let this one stew in my bat cave for THREE years! It didn’t really seem to help</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="word-significance-bag-of-words-with-tf-idf-vectorizer" class="level4">
<h4 class="anchored" data-anchor-id="word-significance-bag-of-words-with-tf-idf-vectorizer">5. Word significance: bag of words with TF-IDF vectorizer</h4>
<p><img src="index_files/figure-html/4bcc8eed-1-c417210e4d54432ef548205c26db360f.png" class="img-fluid"></p>
<p>Next, I define a TF-IDF vectorizer.</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction.text <span class="im">import</span> TfidfVectorizer</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_sm"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tokenize_lemma(text):</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> filter_only_characters(text)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lemmatize, lowercase, strip each word token</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [w.lemma_.lower().strip() <span class="cf">for</span> w <span class="kw">in</span> nlp(text)]</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>TFIDFEncoder <span class="op">=</span> TfidfVectorizer(</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    ngram_range<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">2</span>), </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># A list of stop words: common, wine nomenclature, dates</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    stop_words<span class="op">=</span>STOP_WORDS, </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    tokenizer<span class="op">=</span>tokenize_lemma,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sentence-abstraction-transform-reviews-into-sentence-embeddings" class="level4">
<h4 class="anchored" data-anchor-id="sentence-abstraction-transform-reviews-into-sentence-embeddings">6. Sentence abstraction: transform reviews into sentence embeddings</h4>
<p><img src="index_files/figure-html/3b9f3a48-1-6d709a2840c9d600402773950fc3e321.png" class="img-fluid"></p>
<p>Here is a (scikit-learn) transformer that creates embeddings using the sentence transformer.</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sentence_transformers <span class="im">import</span> SentenceTransformer</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, TransformerMixin</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># New sentence embedding model</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>embeddingModelName <span class="op">=</span> <span class="st">"all-roberta-large-v1"</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>sentenceModel <span class="op">=</span> SentenceTransformer(embeddingModelName)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>outputDim <span class="op">=</span> sentenceModel.get_sentence_embedding_dimension()</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Embedding transformer</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SBERTEncoder(BaseEstimator, TransformerMixin):</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, X):</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create embeddings</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        embeddings <span class="op">=</span> sentenceModel.encode(</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>            <span class="bu">list</span>(X.iloc[:,<span class="dv">0</span>]), </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>            normalize_embeddings <span class="op">=</span> <span class="va">True</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rescale to between 0 and 1</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        embeddings <span class="op">=</span> embeddings <span class="op">-</span> np.<span class="bu">min</span>(embeddings)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        embeddings <span class="op">/=</span> np.<span class="bu">max</span>(embeddings)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> embeddings</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="combine-engineered-features" class="level4">
<h4 class="anchored" data-anchor-id="combine-engineered-features">7. Combine engineered features</h4>
<p><img src="index_files/figure-html/6c198042-1-2fd31c7655decf54bf7d520c5f9e54e2.png" class="img-fluid"></p>
<p>Finally, I create a column transformer that plucks the data columns we want and applies various transformers to them. The outputs of each transformer are merged back together into a large (semi-)sparse matrix.</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dill</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> FeatureUnion, Pipeline</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, TransformerMixin</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ItemSelector(BaseEstimator, TransformerMixin):</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, key, make_df <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.key <span class="op">=</span> key</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.make_df <span class="op">=</span> make_df</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, X):</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.make_df:</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd.DataFrame(X[<span class="va">self</span>.key])</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> X[<span class="va">self</span>.key]</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>FullSentenceTransformer <span class="op">=</span> ColumnTransformer([</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'StarRating_transformer'</span>, <span class="st">'passthrough'</span>, [<span class="st">'unit_rating'</span>]),</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'TFIDFEncoder_transformer'</span>, TFIDFEncoder,  <span class="st">'reviews_clean'</span>),</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'SentenceEmbeddings_transformer'</span>, SBERTEncoder(), [<span class="st">'reviews_clean'</span>]),</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> FullSentenceTransformer.fit_transform(df)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>vocabulary <span class="op">=</span> FullSentenceTransformer.transformers_[<span class="dv">1</span>][<span class="dv">1</span>].vocabulary_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="label-encode-classes" class="level4">
<h4 class="anchored" data-anchor-id="label-encode-classes">8. Label encode classes</h4>
<p>XGBoost and LightGBM require the classes be encoded as integers while the other algorithms do not. Might as well encode everything.</p>
<div class="cell" data-execution_count="274">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>LE <span class="op">=</span> LabelEncoder()</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>y_encoded <span class="op">=</span> LE.fit_transform(df[<span class="st">'sentiment'</span>])</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>y_encoded_classes <span class="op">=</span> LE.classes_</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>y_encoded_classes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="274">
<pre><code>array(["Don't know", 'Negative', 'Positive'], dtype=object)</code></pre>
</div>
</div>
</section>
<section id="split-data-into-training-and-test-sets" class="level4">
<h4 class="anchored" data-anchor-id="split-data-into-training-and-test-sets">9. Split data into training and test sets</h4>
<div class="cell" data-execution_count="275">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>seed <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>splitFraction <span class="op">=</span> <span class="fl">0.85</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                                                    y_encoded, </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                                                    train_size<span class="op">=</span>splitFraction, </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                                                    random_state<span class="op">=</span>seed,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                                                    stratify <span class="op">=</span> y_encoded) </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                                <span class="co"># stratify tries to ensure the split has equal class proprotions</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Training set shape: </span><span class="sc">{</span>X_train<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Testing set shape: </span><span class="sc">{</span>X_test<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training set shape: (4387, 28436)
Testing set shape: (775, 28436)</code></pre>
</div>
</div>
</section>
<section id="create-weights-for-imbalanced-data" class="level4">
<h4 class="anchored" data-anchor-id="create-weights-for-imbalanced-data">10. Create weights for imbalanced data</h4>
<p>A common solution to imbalanced data is to under- or oversample until the class frequencies are equal. Under-sampling throws out data and reduces the diversity in majority classes. Oversampling duplicates random samples from the minority classes and increases computation time when machine learning.</p>
<p>I prefer re-weighting the loss function by the class weights, which works for most models. Its effectively the same as oversampling without the computational expense and random sampling.</p>
<p>Another really interesting solution is to do sentence augmentation which is oversampling plus a rearrangement of the sentences. This is more applicable considering most sentences are disjoint from others in a short review. This is a work in progress that I will revisit! For now, I stick with class re-weighting.</p>
<div class="cell" data-execution_count="16">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.utils.class_weight <span class="im">import</span> compute_sample_weight, compute_class_weight</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>sample_weight_train <span class="op">=</span> compute_sample_weight(class_weight <span class="op">=</span> <span class="st">'balanced'</span>, y <span class="op">=</span> y_train)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>class_name <span class="op">=</span> np.unique(y_train)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>class_weight_train <span class="op">=</span> compute_class_weight(class_weight <span class="op">=</span> <span class="st">'balanced'</span>, classes<span class="op">=</span>class_name, y <span class="op">=</span> y_train)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>class_weight_train <span class="op">=</span> class_weight_train<span class="op">/</span>np.<span class="bu">min</span>(class_weight_train)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>class_weight_dict <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(class_name,class_weight_train))</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>class_weight_dict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>{0: 5.014705882352941, 1: 2.4466367713004487, 2: 1.0}</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="model-fits" class="level1">
<h1>Model Fits</h1>
<p>There are 5,500 samples of data with thousands of features. The data is imbalanced with a category distribution of 6/2/1. There are several machine learning algorithms that we can try.</p>
<ul>
<li>Dummy Classifier (for comparison)</li>
<li>Logistic Regression</li>
<li>(Complement) Naive Bayes</li>
<li>SVMs (not advised due to large number of features, but we try)</li>
<li>Random Forests</li>
<li>XGBoost and LightGBM</li>
</ul>
</section>
<section id="model-results" class="level1">
<h1>Model Results</h1>
<p>The training calculations are appended at the end of this post. Below are the ROC and PR curves for each model.</p>
<p>XGBoost and LightGBM models have the highest ROC AUCs which suggests these are the models to adopt. However, imbalanced datasets inherently have fewer “True Negatives” which limits the dynamic range of the false positive rate (x-axis of ROC). As a result, the ROC AUC is greater or more optimistic than we’d think for imbalanced datasets.</p>
<p>A more sensitive measure for minority classes is Precision (i.e., your predictive power). If we replace the False Positive Rate in the ROC curve with Precision and invert the X and Y axes, you get the PR curve.</p>
<p>We can see that the PR AUC is poor for CNB (which is disappointing because it is extremely fast to compute). The DKs are marginally better than random chance.</p>
<p>The PR AUCs suggests the <strong>XGBoost model</strong> is better performing than the LightGBM model by a little bit. (To be fair, I did not explore many LGBMs because it is slower to compute for smaller datasets and they perform relatively equally well.)</p>
<p>Here are the AUC results from all our models.</p>
<div class="cell" data-execution_count="183">
<div class="cell-output cell-output-display" data-execution_count="183">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Model Name</th>
<th></th>
<th style="text-align: left;">ROC AUC</th>
<th></th>
<th></th>
<th style="text-align: left;">PR AUC</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"></td>
<td><strong>Don’t know</strong></td>
<td style="text-align: left;"><strong>Negative</strong></td>
<td><strong>Positive</strong></td>
<td><strong>Don’t know</strong></td>
<td style="text-align: left;"><strong>Negative</strong></td>
<td><strong>Positive</strong></td>
</tr>
<tr class="even">
<td style="text-align: left;">LogReg</td>
<td>0.883</td>
<td style="text-align: left;">0.938</td>
<td>0.919</td>
<td>0.536</td>
<td style="text-align: left;">0.837</td>
<td>0.951</td>
</tr>
<tr class="odd">
<td style="text-align: left;">C. Naive Bayes</td>
<td>0.868</td>
<td style="text-align: left;">0.937</td>
<td>0.916</td>
<td>0.470</td>
<td style="text-align: left;">0.850</td>
<td>0.948</td>
</tr>
<tr class="even">
<td style="text-align: left;">SVC</td>
<td>0.839</td>
<td style="text-align: left;">0.922</td>
<td>0.914</td>
<td>0.489</td>
<td style="text-align: left;">0.817</td>
<td>0.948</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RFC</td>
<td>0.900</td>
<td style="text-align: left;">0.937</td>
<td>0.923</td>
<td>0.581</td>
<td style="text-align: left;">0.836</td>
<td>0.953</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>XGBoost</strong></td>
<td>0.900</td>
<td style="text-align: left;">0.937</td>
<td>0.923</td>
<td>0.581</td>
<td style="text-align: left;">0.836</td>
<td>0.953</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LightGBM</td>
<td>0.900</td>
<td style="text-align: left;">0.938</td>
<td>0.923</td>
<td>0.575</td>
<td style="text-align: left;">0.839</td>
<td>0.953</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Here are 20 words that the XGBoost classifier found to have the highest significance. In another post, I’ll go deeper into which words are the most significant per category.</p>
<div class="cell" data-execution_count="327">
<div class="cell-output cell-output-display" data-execution_count="327">
<table class="table table-sm table-striped small">
<caption>Top 20 Most Significant Words (XGBoost) </caption>
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">Score</th>
<th style="text-align: left;">Word</th>
<th style="text-align: right;">Score</th>
<th style="text-align: left;">Word</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">3.61</td>
<td style="text-align: left;">not</td>
<td style="text-align: right;">1.59</td>
<td style="text-align: left;">well than</td>
</tr>
<tr class="even">
<td style="text-align: right;">3.24</td>
<td style="text-align: left;">value</td>
<td style="text-align: right;">1.58</td>
<td style="text-align: left;">decent</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2.73</td>
<td style="text-align: left;">great</td>
<td style="text-align: right;">1.46</td>
<td style="text-align: left;">not worth</td>
</tr>
<tr class="even">
<td style="text-align: right;">2.48</td>
<td style="text-align: left;">but</td>
<td style="text-align: right;">1.46</td>
<td style="text-align: left;">not bad</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2.45</td>
<td style="text-align: left;">delicious</td>
<td style="text-align: right;">1.44</td>
<td style="text-align: left;">good but</td>
</tr>
<tr class="even">
<td style="text-align: right;">2.25</td>
<td style="text-align: left;">bad</td>
<td style="text-align: right;">1.33</td>
<td style="text-align: left;">not great</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.67</td>
<td style="text-align: left;">good</td>
<td style="text-align: right;">1.33</td>
<td style="text-align: left;">overprice</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.62</td>
<td style="text-align: left;">bitter</td>
<td style="text-align: right;">1.33</td>
<td style="text-align: left;">pricey</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.62</td>
<td style="text-align: left;">good value</td>
<td style="text-align: right;">1.28</td>
<td style="text-align: left;">region</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.59</td>
<td style="text-align: left;">worth</td>
<td style="text-align: right;">1.26</td>
<td style="text-align: left;">yes</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Here are the ROC and PR curves for each model. The code to fit these models are further below.</p>
<section id="logistic-regression" class="level2">
<h2 class="anchored" data-anchor-id="logistic-regression">1. Logistic Regression</h2>
<p><img src="index_files/figure-html/35623c9b-1-LogisticRegression.png" class="img-fluid"></p>
</section>
<section id="complement-naive-bayes" class="level2">
<h2 class="anchored" data-anchor-id="complement-naive-bayes">2. Complement Naive Bayes</h2>
<p><img src="index_files/figure-html/c7d7f010-1-CNB.png" class="img-fluid"></p>
</section>
<section id="support-vector-machine" class="level2">
<h2 class="anchored" data-anchor-id="support-vector-machine">3. Support Vector Machine</h2>
<p><img src="index_files/figure-html/077d37d3-1-SVC.png" class="img-fluid"></p>
</section>
<section id="random-forest-classifier" class="level2">
<h2 class="anchored" data-anchor-id="random-forest-classifier">4. Random Forest Classifier</h2>
<p><img src="index_files/figure-html/07e74891-1-RFC.png" class="img-fluid"></p>
</section>
<section id="xgboost-winner" class="level2">
<h2 class="anchored" data-anchor-id="xgboost-winner">5. XGBoost (Winner!)</h2>
<p><img src="index_files/figure-html/2f943191-1-XGBC.png" class="img-fluid"></p>
</section>
<section id="lightgbm" class="level2">
<h2 class="anchored" data-anchor-id="lightgbm">6. LightGBM</h2>
<p><img src="index_files/figure-html/24dda970-1-LGBM.png" class="img-fluid"></p>
</section>
</section>
<section id="model-training-code" class="level1">
<h1>Model Training Code</h1>
<section id="a.-dummy-classifier" class="level2">
<h2 class="anchored" data-anchor-id="a.-dummy-classifier">A. Dummy Classifier</h2>
<p>The dummy classifier ignores input features. “Stratified” predicts based on the occurrence frequency of classes from the training set. Our custom weighted score is also shown. This is our baseline.</p>
<div class="cell" data-execution_count="182">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.dummy <span class="im">import</span> DummyClassifier</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>modelName <span class="op">=</span> <span class="st">'DummyClassifier'</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline([</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    (modelName, DummyClassifier(strategy<span class="op">=</span><span class="st">"stratified"</span>)), </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> pipe</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train) </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> fdir_model <span class="op">+</span> <span class="ss">f'</span><span class="sc">{</span>modelName<span class="sc">}</span><span class="ss">.dill'</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>dill.dump(model, <span class="bu">open</span>(fname, <span class="st">'wb'</span>))</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>plot_roc_pr(fname)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-25-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="b.-logistic-regression" class="level2">
<h2 class="anchored" data-anchor-id="b.-logistic-regression">B. Logistic Regression</h2>
<p>Basic logistic function with L2 regularization.</p>
<div class="cell" data-execution_count="131">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>modelName <span class="op">=</span> <span class="st">"LogisticRegression"</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline([</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    (modelName, LogisticRegression(max_iter<span class="op">=</span><span class="dv">10000</span>, random_state<span class="op">=</span><span class="dv">42</span>)), </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {<span class="st">"C"</span>: <span class="dv">10</span><span class="op">**</span>np.arange(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span><span class="op">+</span><span class="fl">0.25</span>, <span class="fl">0.2</span>)}</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {<span class="ss">f"</span><span class="sc">{</span>modelName<span class="sc">}</span><span class="ss">__</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>: param_grid[k] <span class="cf">for</span> k <span class="kw">in</span> param_grid.keys()}</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> GridSearchCV(pipe, </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>                     param_grid <span class="op">=</span> param_grid,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>                     cv <span class="op">=</span> <span class="dv">5</span>,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>                     n_jobs<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>                     scoring <span class="op">=</span> sentimentScorer,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>kwargs_fit <span class="op">=</span> {modelName<span class="op">+</span><span class="st">'__sample_weight'</span>:sample_weight_train}</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train, <span class="op">**</span>kwargs_fit) </span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The best hyperparameter value is: "</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k,v <span class="kw">in</span> model.best_params_.items():</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> fdir_model <span class="op">+</span> <span class="ss">f'</span><span class="sc">{</span>modelName<span class="sc">}</span><span class="ss">.dill'</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>dill.dump(model, <span class="bu">open</span>(fname, <span class="st">'wb'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The best hyperparameter value is: 
LogisticRegression__C: 0.9999999999999994</code></pre>
</div>
</div>
<div class="cell" data-execution_count="132">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-27-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="133">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="134">
<div class="cell-output cell-output-display" data-execution_count="134">
<table class="table table-sm table-striped small">
<caption>Highest polarity words: Logistic Regression </caption>
<colgroup>
<col style="width: 10%">
<col style="width: 40%">
<col style="width: 10%">
<col style="width: 40%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">Polarity</th>
<th style="text-align: left;">Positive Words</th>
<th style="text-align: right;">Polarity</th>
<th style="text-align: left;">Negative Words</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2.85</td>
<td style="text-align: left;">good abv</td>
<td style="text-align: right;">-4.18</td>
<td style="text-align: left;">not bargain</td>
</tr>
<tr class="even">
<td style="text-align: right;">2.56</td>
<td style="text-align: left;">great absolute</td>
<td style="text-align: right;">-4.16</td>
<td style="text-align: left;">decent absolute</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.94</td>
<td style="text-align: left;">good valueprice</td>
<td style="text-align: right;">-3.82</td>
<td style="text-align: left;">bad acidic</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.68</td>
<td style="text-align: left;">value able</td>
<td style="text-align: right;">-3.44</td>
<td style="text-align: left;">not able</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.35</td>
<td style="text-align: left;">excellent approachable</td>
<td style="text-align: right;">-2.79</td>
<td style="text-align: left;">ok atar</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.32</td>
<td style="text-align: left;">pretty great</td>
<td style="text-align: right;">-1.75</td>
<td style="text-align: left;">decent well</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.32</td>
<td style="text-align: left;">nice above</td>
<td style="text-align: right;">-1.72</td>
<td style="text-align: left;">bad purchase</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.32</td>
<td style="text-align: left;">great versatile</td>
<td style="text-align: right;">-1.66</td>
<td style="text-align: left;">not ws</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.28</td>
<td style="text-align: left;">worth average</td>
<td style="text-align: right;">-1.63</td>
<td style="text-align: left;">like grab</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.22</td>
<td style="text-align: left;">pretty acidic</td>
<td style="text-align: right;">-1.58</td>
<td style="text-align: left;">not worthy</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="c.-complement-naive-bayes" class="level2">
<h2 class="anchored" data-anchor-id="c.-complement-naive-bayes">C. Complement Naive Bayes</h2>
<p>Complement Naive Bayes is apparently the corrected version of MNB when there is imbalanced data.</p>
<p>Note: this is an extremely fast algorithm!</p>
<div class="cell" data-execution_count="156">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.naive_bayes <span class="im">import</span> ComplementNB</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>modelName <span class="op">=</span> <span class="st">"ComplementNB"</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline([</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    (modelName, ComplementNB()), </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {<span class="st">"alpha"</span>: <span class="dv">10</span><span class="op">**</span>np.arange(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>, <span class="fl">0.01</span>)}</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {<span class="ss">f"</span><span class="sc">{</span>modelName<span class="sc">}</span><span class="ss">__</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>: param_grid[k] <span class="cf">for</span> k <span class="kw">in</span> param_grid.keys()}</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> GridSearchCV(pipe, </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>                     param_grid <span class="op">=</span> param_grid,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>                     cv <span class="op">=</span> <span class="dv">10</span>,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>                     n_jobs<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>                     scoring <span class="op">=</span> sentimentScorer,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>                     return_train_score <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>kwargs_fit <span class="op">=</span> {modelName<span class="op">+</span><span class="st">'__sample_weight'</span>:sample_weight_train}</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train, <span class="op">**</span>kwargs_fit) </span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The best hyperparameters: "</span>)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k,v <span class="kw">in</span> model.best_params_.items():</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> fdir_model <span class="op">+</span> <span class="ss">f'</span><span class="sc">{</span>modelName<span class="sc">}</span><span class="ss">.dill'</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>dill.dump(model, <span class="bu">open</span>(fname, <span class="st">'wb'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The best hyperparameters: 
ComplementNB__alpha: 4.7863009232264</code></pre>
</div>
</div>
<div class="cell" data-execution_count="157">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-31-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="159">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-32-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="96">
<div class="cell-output cell-output-display" data-execution_count="96">
<table class="table table-sm table-striped small">
<caption>Highest polarity words </caption>
<colgroup>
<col style="width: 10%">
<col style="width: 40%">
<col style="width: 10%">
<col style="width: 40%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">Polarity</th>
<th style="text-align: left;">Positive Words</th>
<th style="text-align: right;">Polarity</th>
<th style="text-align: left;">Negative Words</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1.68</td>
<td style="text-align: left;">great versatile</td>
<td style="text-align: right;">-1.98</td>
<td style="text-align: left;">not worthy</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.44</td>
<td style="text-align: left;">good valueprice</td>
<td style="text-align: right;">-1.94</td>
<td style="text-align: left;">bad acidic</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.2</td>
<td style="text-align: left;">value able</td>
<td style="text-align: right;">-1.93</td>
<td style="text-align: left;">not bargain</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.16</td>
<td style="text-align: left;">great absolute</td>
<td style="text-align: right;">-1.41</td>
<td style="text-align: left;">ok atar</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.95</td>
<td style="text-align: left;">great pricepoint</td>
<td style="text-align: right;">-1.04</td>
<td style="text-align: left;">would ok</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.89</td>
<td style="text-align: left;">steal but</td>
<td style="text-align: right;">-0.98</td>
<td style="text-align: left;">decent absolute</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.86</td>
<td style="text-align: left;">excellent vfm</td>
<td style="text-align: right;">-0.9</td>
<td style="text-align: left;">overprice artificially</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.86</td>
<td style="text-align: left;">excellent approachable</td>
<td style="text-align: right;">-0.88</td>
<td style="text-align: left;">not able</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.75</td>
<td style="text-align: left;">beat beat</td>
<td style="text-align: right;">-0.88</td>
<td style="text-align: left;">not cad</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.74</td>
<td style="text-align: left;">would challenge</td>
<td style="text-align: right;">-0.86</td>
<td style="text-align: left;">not grab</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="d.-support-vector-machine" class="level2">
<h2 class="anchored" data-anchor-id="d.-support-vector-machine">D. Support Vector Machine</h2>
<p>SVM attempts to draw boundaries between classes of points using hypersurfaces. Each surface has a margin or “thickness” where points inside the margin become ‘support vectors’ which, in fact, define the hyper surface.</p>
<p>The amount of “slack” given to a proposed hypersurface is defined by points located on the wrong side of the hypersurface. The total slack is quantified by the sum of distance (or whatever penalty you define) between these points to the surface. A regularization parameter is used to control the strength of a penalty applied from slack. This is defined as <em>C</em> in the following code.</p>
<p>The hypersurface is a hyperplane (i.e., linear) by default. A kernel trick is used to allow malleable surfaces. I will explore a number of kernels which have their own hyperparameters (e.g., dimension of polynomial).</p>
<p>Note: The assumption that the data can be split using a hyperplane is quite strong considering the sparsity of the data and extremely high number of features. SVMs are quite expensive for high numbers of features much like KNNs since the algorithm requires an interpolation of subsets of points (a generally slow process).</p>
<div class="cell" data-execution_count="136">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.svm <span class="im">import</span> SVC</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> linear(X, Y):</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.dot(X, Y.T)  </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>modelName <span class="op">=</span> <span class="st">"SVC"</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline([</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    (modelName, SVC(class_weight<span class="op">=</span><span class="st">'balanced'</span>, cache_size<span class="op">=</span><span class="dv">2000</span>, random_state<span class="op">=</span><span class="dv">42</span>)), </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>C_param <span class="op">=</span> <span class="dv">10</span><span class="op">**</span>np.arange(<span class="dv">0</span>, <span class="dv">2</span><span class="op">+</span><span class="fl">0.5</span>, <span class="fl">0.25</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> [</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'kernel'</span>: [linear], <span class="st">'C'</span>: C_param}, <span class="co"># This is much faster than default linear</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'kernel'</span>: [<span class="st">'poly'</span>], <span class="st">'degree'</span>: [<span class="dv">2</span>,<span class="dv">3</span>], <span class="st">'C'</span>: C_param},</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'kernel'</span>:  [<span class="st">'rbf'</span>], <span class="st">'C'</span>: C_param},</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> [</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    {<span class="ss">f"</span><span class="sc">{</span>modelName<span class="sc">}</span><span class="ss">__</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>: grid[k] <span class="cf">for</span> k <span class="kw">in</span> grid.keys()} <span class="cf">for</span> grid <span class="kw">in</span> param_grid</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> GridSearchCV(pipe, </span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>                     param_grid <span class="op">=</span> param_grid,</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>                     cv <span class="op">=</span> <span class="dv">5</span>, <span class="co">#Reduced for time</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>                     n_jobs<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>                     scoring <span class="op">=</span> sentimentScorer,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train) </span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The best hyperparameters: "</span>)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k,v <span class="kw">in</span> model.best_params_.items():</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> fdir_model <span class="op">+</span> <span class="ss">f'</span><span class="sc">{</span>modelName<span class="sc">}</span><span class="ss">.dill'</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>dill.dump(model, <span class="bu">open</span>(fname, <span class="st">'wb'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The best hyperparameters: 
SVC__C: 56.23413251903491
SVC__kernel: rbf</code></pre>
</div>
</div>
<div class="cell" data-execution_count="137">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-35-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="138">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-36-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="e.-random-forest" class="level2">
<h2 class="anchored" data-anchor-id="e.-random-forest">E. Random Forest</h2>
<p>There are many parameters in a decision tree and many more when aggregating over a forest of decision trees. Here are all of the relevant parameters we can change (<a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html#sklearn.ensemble.RandomForestClassifier">source</a>):</p>
<p>Note: Grid search was not extensive due to speed! Skipped to LGBM and XGBoost.</p>
<div class="cell" data-execution_count="65">
<div class="cell-output cell-output-display" data-execution_count="65">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n_estimators</td>
<td style="text-align: left;">The number of trees in the forest.</td>
</tr>
<tr class="even">
<td style="text-align: left;">max_depth</td>
<td style="text-align: left;">The maximum depth of tree from the root.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">min_samples_split</td>
<td style="text-align: left;">Minimum number of samples required for a split to be considered.</td>
</tr>
<tr class="even">
<td style="text-align: left;">min_samples_leaf</td>
<td style="text-align: left;">Minimum number of samples required for each leaf.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">max_features</td>
<td style="text-align: left;">The number of features to consider when choosing a split for an internal node.</td>
</tr>
<tr class="even">
<td style="text-align: left;">bootstrap</td>
<td style="text-align: left;">Whether bootstrap samples are used when building trees.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">oob_score</td>
<td style="text-align: left;">Whether to use out-of-bag samples to estimate the generalization accuracy.</td>
</tr>
<tr class="even">
<td style="text-align: left;">n_jobs</td>
<td style="text-align: left;">The number of jobs to run in parallel for both fit and predict. If -1, then the number of jobs is set to the number of cores.Criterion for splitting quality: Gini, Entropy, or Log Loss</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-execution_count="140">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>modelName <span class="op">=</span> <span class="st">"RFC"</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline([</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    (modelName, RandomForestClassifier(class_weight<span class="op">=</span><span class="st">'balanced'</span>,random_state<span class="op">=</span><span class="dv">42</span>)), </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'n_estimators'</span>: [<span class="dv">1000</span>], </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_depth'</span>: [<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>], </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'min_samples_split'</span>: [<span class="dv">2</span>],</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'min_samples_leaf'</span>: [<span class="dv">1</span>],</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'criterion'</span>: [<span class="st">'gini'</span>, <span class="st">'log_loss'</span>],</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {<span class="ss">f"</span><span class="sc">{</span>modelName<span class="sc">}</span><span class="ss">__</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>: param_grid[k] <span class="cf">for</span> k <span class="kw">in</span> param_grid.keys()}</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> GridSearchCV(pipe, </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>                     param_grid <span class="op">=</span> param_grid,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>                     cv <span class="op">=</span> <span class="dv">5</span>,</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>                     n_jobs<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>                     scoring <span class="op">=</span> sentimentScorer,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train) </span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The best hyperparameters: "</span>)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k,v <span class="kw">in</span> model.best_params_.items():</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> fdir_model <span class="op">+</span> <span class="ss">f'</span><span class="sc">{</span>modelName<span class="sc">}</span><span class="ss">.dill'</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>dill.dump(model, <span class="bu">open</span>(fname, <span class="st">'wb'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The best hyperparameters: 
RFC__criterion: gini
RFC__max_depth: 6
RFC__min_samples_leaf: 1
RFC__min_samples_split: 2
RFC__n_estimators: 1000</code></pre>
</div>
</div>
<div class="cell" data-execution_count="141">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-39-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="142">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-40-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="f.-xgboost" class="level2">
<h2 class="anchored" data-anchor-id="f.-xgboost">F. XGBoost</h2>
<div class="cell" data-execution_count="146">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBClassifier</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>modelName <span class="op">=</span> <span class="st">"XGBC"</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline([</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    (modelName, XGBClassifier(tree_method<span class="op">=</span><span class="st">'gpu_hist'</span>, random_state<span class="op">=</span><span class="dv">42</span>)), </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'eta'</span>: [<span class="fl">1e-2</span>],</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'n_estimators'</span>: [<span class="dv">1000</span>], </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_depth'</span>: [<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>], </span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'min_child_weight'</span>: [<span class="dv">1</span>],</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subsample'</span>: [<span class="fl">0.5</span>, <span class="fl">0.8</span>],</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'colsample_bytree'</span>: [<span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="dv">1</span>]</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {<span class="ss">f"</span><span class="sc">{</span>modelName<span class="sc">}</span><span class="ss">__</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>: param_grid[k] <span class="cf">for</span> k <span class="kw">in</span> param_grid.keys()}</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> GridSearchCV(pipe, </span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>                     param_grid <span class="op">=</span> param_grid,</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>                     cv <span class="op">=</span> <span class="dv">5</span>,</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>                     n_jobs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>                     scoring <span class="op">=</span> sentimentScorer,</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>kwargs_fit <span class="op">=</span> {modelName<span class="op">+</span><span class="st">'__sample_weight'</span>:sample_weight_train}</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train, <span class="op">**</span>kwargs_fit) </span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The best hyperparameters: "</span>)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k,v <span class="kw">in</span> model.best_params_.items():</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="co"># CV does not set this by default... Needed for yellowbricks.</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>model.best_estimator_.steps[<span class="dv">0</span>][<span class="dv">1</span>].set_params(<span class="op">**</span>{<span class="st">'num_class'</span>: <span class="bu">len</span>(LE.classes_)})</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> fdir_model <span class="op">+</span> <span class="ss">f'</span><span class="sc">{</span>modelName<span class="sc">}</span><span class="ss">.dill'</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>dill.dump(model, <span class="bu">open</span>(fname, <span class="st">'wb'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The best hyperparameters: 
XGBC__colsample_bytree: 0.8
XGBC__eta: 0.01
XGBC__max_depth: 4
XGBC__min_child_weight: 1
XGBC__n_estimators: 1000
XGBC__subsample: 0.8</code></pre>
</div>
</div>
<div class="cell" data-execution_count="147">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-42-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="g.-lightgbm" class="level2">
<h2 class="anchored" data-anchor-id="g.-lightgbm">G. LightGBM</h2>
<div class="cell" data-execution_count="148">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightgbm <span class="im">import</span> LGBMClassifier</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>modelName <span class="op">=</span> <span class="st">"LGBM"</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline([</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    (modelName, LGBMClassifier(class_weight<span class="op">=</span><span class="st">"balanced"</span>, random_state<span class="op">=</span> <span class="dv">42</span>,  device<span class="op">=</span><span class="st">'gpu'</span>, verbose<span class="op">=-</span><span class="dv">1</span>)), </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'learning_rate'</span>: [<span class="fl">1e-2</span>], </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_depth'</span>: [<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>], </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subsample'</span>: [<span class="fl">0.5</span>, <span class="fl">0.8</span>],</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'n_estimators'</span>: [<span class="dv">1000</span>],</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'reg_lambda'</span>: [<span class="dv">1</span>],</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'colsample_bytree'</span>: [<span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="dv">1</span>]</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {<span class="ss">f"</span><span class="sc">{</span>modelName<span class="sc">}</span><span class="ss">__</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>: param_grid[k] <span class="cf">for</span> k <span class="kw">in</span> param_grid.keys()}</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> GridSearchCV(pipe, </span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>                     param_grid <span class="op">=</span> param_grid,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>                     cv <span class="op">=</span> <span class="dv">5</span>,</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>                     n_jobs<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>                     scoring <span class="op">=</span> sentimentScorer,</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train) </span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The best hyperparameters: "</span>)</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k,v <span class="kw">in</span> model.best_params_.items():</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> fdir_model <span class="op">+</span> <span class="st">'LGBM.dill'</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>dill.dump(model, <span class="bu">open</span>(fname, <span class="st">'wb'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The best hyperparameters: 
LGBM__colsample_bytree: 0.5
LGBM__learning_rate: 0.01
LGBM__max_depth: 4
LGBM__n_estimators: 1000
LGBM__reg_lambda: 1
LGBM__subsample: 0.5</code></pre>
</div>
</div>
<div class="cell" data-execution_count="149">
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-44-output-1.png" class="img-fluid"></p>
</div>
</div>


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{ro2023,
  author = {Ro, Stephen},
  title = {Judging {Wine} {Prices:} {Selecting} a {Model} {(Part} 2)},
  date = {2023-07-11},
  url = {https://royourboat.github.io/posts/2023-07-11-price-sentiment-2/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-ro2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Ro, Stephen. 2023. <span>“Judging Wine Prices: Selecting a Model (Part
2).”</span> July 11, 2023. <a href="https://royourboat.github.io/posts/2023-07-11-price-sentiment-2/">https://royourboat.github.io/posts/2023-07-11-price-sentiment-2/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>